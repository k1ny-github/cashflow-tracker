<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cashflow Tracker - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –§–∏–Ω–∞–Ω—Å–∞–º–∏</title>
  <style>
    :root {
  /* Primitive Color Tokens */
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);

  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;
  --color-red-500-rgb: 192, 21, 47;
  --color-red-400-rgb: 255, 84, 89;
  --color-orange-500-rgb: 168, 75, 47;
  --color-orange-400-rgb: 230, 129, 97;

  --color-bg-1: rgba(59, 130, 246, 0.08);
  --color-bg-2: rgba(245, 158, 11, 0.08);
  --color-bg-3: rgba(34, 197, 94, 0.08);
  --color-bg-4: rgba(239, 68, 68, 0.08);
  --color-bg-5: rgba(147, 51, 234, 0.08);
  --color-bg-6: rgba(249, 115, 22, 0.08);
  --color-bg-7: rgba(236, 72, 153, 0.08);
  --color-bg-8: rgba(6, 182, 212, 0.08);

  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
  --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

  --focus-ring: 0 0 0 3px var(--color-focus-ring);
  --focus-outline: 2px solid var(--color-primary);
  --status-bg-opacity: 0.15;
  --status-border-opacity: 0.25;
  --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

  --color-success-rgb: 33, 128, 141;
  --color-error-rgb: 192, 21, 47;
  --color-warning-rgb: 168, 75, 47;
  --color-info-rgb: 98, 108, 113;

  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-size-4xl: 30px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --letter-spacing-tight: -0.01em;

  --space-0: 0;
  --space-1: 1px;
  --space-2: 2px;
  --space-4: 4px;
  --space-6: 6px;
  --space-8: 8px;
  --space-10: 10px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;

  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --radius-full: 9999px;

  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);

  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

  --container-sm: 640px;
  --container-md: 768px;
  --container-lg: 1024px;
  --container-xl: 1280px;
}

@media (prefers-color-scheme: dark) {
  :root {
    --color-gray-400-rgb: 119, 124, 124;
    --color-teal-300-rgb: 50, 184, 198;
    --color-gray-300-rgb: 167, 169, 169;
    --color-gray-200-rgb: 245, 245, 245;

    --color-bg-1: rgba(29, 78, 216, 0.15);
    --color-bg-2: rgba(180, 83, 9, 0.15);
    --color-bg-3: rgba(21, 128, 61, 0.15);
    --color-bg-4: rgba(185, 28, 28, 0.15);
    --color-bg-5: rgba(107, 33, 168, 0.15);
    --color-bg-6: rgba(194, 65, 12, 0.15);
    --color-bg-7: rgba(190, 24, 93, 0.15);
    --color-bg-8: rgba(8, 145, 178, 0.15);

    --color-background: var(--color-charcoal-700);
    --color-surface: var(--color-charcoal-800);
    --color-text: var(--color-gray-200);
    --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
    --color-primary: var(--color-teal-300);
    --color-primary-hover: var(--color-teal-400);
    --color-primary-active: var(--color-teal-800);
    --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
    --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
    --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
    --color-border: rgba(var(--color-gray-400-rgb), 0.3);
    --color-error: var(--color-red-400);
    --color-success: var(--color-teal-300);
    --color-warning: var(--color-orange-400);
    --color-info: var(--color-gray-300);
    --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
    --color-btn-primary-text: var(--color-slate-900);
    --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
    --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
    --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.15);
    --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
    --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

    --color-success-rgb: var(--color-teal-300-rgb);
    --color-error-rgb: var(--color-red-400-rgb);
    --color-warning-rgb: var(--color-orange-400-rgb);
    --color-info-rgb: var(--color-gray-300-rgb);
  }
}

@font-face {
  font-family: 'FKGroteskNeue';
  src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
}

html {
  font-size: var(--font-size-base);
  font-family: var(--font-family-base);
  line-height: var(--line-height-normal);
  color: var(--color-text);
  background-color: var(--color-background);
  -webkit-font-smoothing: antialiased;
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
}

*, *::before, *::after {
  box-sizing: inherit;
}

    /* Custom App Styles */
    .app-container {
      min-height: 100vh;
      padding: var(--space-24) var(--space-16);
    }

    .app-header {
      max-width: 1200px;
      margin: 0 auto var(--space-32);
      text-align: center;
    }

    .app-title {
      font-size: var(--font-size-4xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-8);
      color: var(--color-text);
    }

    .app-subtitle {
      font-size: var(--font-size-lg);
      color: var(--color-text-secondary);
    }

    .tabs {
      max-width: 1200px;
      margin: 0 auto var(--space-32);
      display: flex;
      gap: var(--space-8);
      flex-wrap: wrap;
      justify-content: center;
    }

    .tab-button {
      padding: var(--space-12) var(--space-24);
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      color: var(--color-text);
      border-radius: var(--radius-base);
      cursor: pointer;
      font-size: var(--font-size-md);
      font-weight: var(--font-weight-medium);
      transition: all var(--duration-fast) var(--ease-standard);
    }

    .tab-button:hover {
      background: var(--color-secondary-hover);
      border-color: var(--color-primary);
    }

    .tab-button.active {
      background: var(--color-primary);
      color: var(--color-btn-primary-text);
      border-color: var(--color-primary);
    }

    .content {
      max-width: 1200px;
      margin: 0 auto;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .grid {
      display: grid;
      gap: var(--space-24);
    }

    .grid-2 {
      grid-template-columns: 1fr;
    }

    @media (min-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr 1fr;
      }
    }

    .card {
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      padding: var(--space-24);
      box-shadow: var(--shadow-sm);
    }

    .card-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--space-16);
      color: var(--color-text);
    }

    .form-group {
      margin-bottom: var(--space-16);
    }

    .form-label {
      display: block;
      margin-bottom: var(--space-8);
      font-weight: var(--font-weight-medium);
      font-size: var(--font-size-sm);
      color: var(--color-text);
    }

    .form-control {
      width: 100%;
      padding: var(--space-10) var(--space-12);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      font-size: var(--font-size-md);
      background: var(--color-surface);
      color: var(--color-text);
      transition: border-color var(--duration-fast) var(--ease-standard);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: var(--focus-ring);
    }

    select.form-control {
      appearance: none;
      background-image: var(--select-caret-light);
      background-repeat: no-repeat;
      background-position: right var(--space-12) center;
      background-size: 16px;
      padding-right: var(--space-32);
    }

    @media (prefers-color-scheme: dark) {
      select.form-control {
        background-image: var(--select-caret-dark);
      }
    }

    .btn {
      padding: var(--space-10) var(--space-20);
      border: none;
      border-radius: var(--radius-base);
      font-size: var(--font-size-md);
      font-weight: var(--font-weight-medium);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-standard);
      display: inline-flex;
      align-items: center;
      gap: var(--space-8);
    }

    .btn-primary {
      background: var(--color-primary);
      color: var(--color-btn-primary-text);
    }

    .btn-primary:hover {
      background: var(--color-primary-hover);
    }

    .btn-delete {
      background: transparent;
      color: var(--color-error);
      border: 1px solid var(--color-error);
      padding: var(--space-6) var(--space-12);
      font-size: var(--font-size-sm);
    }

    .btn-delete:hover {
      background: rgba(var(--color-error-rgb), 0.1);
    }

    .btn-edit {
      background: var(--color-primary);
      color: var(--color-btn-primary-text);
      border: 1px solid var(--color-primary);
      padding: var(--space-6) var(--space-12);
      font-size: var(--font-size-sm);
      margin-right: var(--space-8);
    }

    .btn-edit:hover {
      background: var(--color-primary-hover);
    }

    .btn-cancel {
      background: var(--color-secondary);
      color: var(--color-text);
      border: 1px solid var(--color-border);
      padding: var(--space-10) var(--space-20);
      font-size: var(--font-size-md);
      margin-left: var(--space-8);
    }

    .btn-cancel:hover {
      background: var(--color-secondary-hover);
    }

    .entry-actions {
      display: flex;
      gap: var(--space-8);
    }

    .entry-item.editing {
      background: var(--color-bg-5);
      border: 2px solid var(--color-primary);
    }

    .form-edit-mode {
      background: var(--color-bg-5);
      border: 2px solid var(--color-primary);
      padding: var(--space-16);
      border-radius: var(--radius-lg);
    }

    .entries-list {
      margin-top: var(--space-24);
    }

    .entry-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-16);
      background: var(--color-bg-1);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-base);
      margin-bottom: var(--space-12);
    }

    .entry-info {
      flex: 1;
    }

    .entry-amount {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--space-4);
    }

    .entry-amount.positive {
      color: var(--color-success);
    }

    .entry-amount.negative {
      color: var(--color-error);
    }

    .entry-category {
      display: inline-block;
      padding: var(--space-4) var(--space-8);
      background: var(--color-secondary);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      margin-bottom: var(--space-4);
    }

    .entry-description {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--space-16);
      margin-bottom: var(--space-32);
    }

    .summary-card {
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      padding: var(--space-20);
      text-align: center;
    }

    .summary-label {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-8);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .summary-value {
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-text);
    }

    .summary-value.positive {
      color: var(--color-success);
    }

    .summary-value.negative {
      color: var(--color-error);
    }

    .cashflow-chart {
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      padding: var(--space-24);
      margin-bottom: var(--space-24);
    }

    .cashflow-bars {
      display: flex;
      gap: var(--space-24);
      margin-top: var(--space-24);
      align-items: flex-end;
      justify-content: center;
      min-height: 300px;
    }

    .cashflow-bar {
      flex: 1;
      max-width: 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .bar {
      width: 100%;
      background: var(--color-primary);
      border-radius: var(--radius-base) var(--radius-base) 0 0;
      position: relative;
      transition: all var(--duration-normal) var(--ease-standard);
      min-height: 40px;
    }

    .bar.expense {
      background: var(--color-error);
    }

    .bar-label {
      margin-top: var(--space-12);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--color-text);
    }

    .bar-value {
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      white-space: nowrap;
    }

    .empty-state {
      text-align: center;
      padding: var(--space-32);
      color: var(--color-text-secondary);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: var(--space-16);
    }

    .breakdown-list {
      margin-top: var(--space-16);
    }

    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-12);
      background: var(--color-bg-2);
      border-radius: var(--radius-base);
      margin-bottom: var(--space-8);
    }

    .breakdown-name {
      font-weight: var(--font-weight-medium);
    }

    .breakdown-value {
      display: flex;
      align-items: center;
      gap: var(--space-12);
    }

    .breakdown-amount {
      font-weight: var(--font-weight-semibold);
    }

    .breakdown-percent {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    .totals {
      margin-top: var(--space-24);
      padding-top: var(--space-24);
      border-top: 2px solid var(--color-border);
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-12);
      font-size: var(--font-size-lg);
    }

    .total-row.main {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      margin-top: var(--space-16);
      padding-top: var(--space-16);
      border-top: 2px solid var(--color-border);
    }

    .financial-health {
      background: var(--color-bg-3);
      border: 2px solid var(--color-success);
      border-radius: var(--radius-lg);
      padding: var(--space-24);
      text-align: center;
      margin-top: var(--space-24);
    }

    .financial-health.warning {
      background: rgba(var(--color-warning-rgb), 0.08);
      border-color: var(--color-warning);
    }

    .financial-health.negative {
      background: rgba(var(--color-error-rgb), 0.08);
      border-color: var(--color-error);
    }

    .snapshot-card {
      background: var(--color-bg-3);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      padding: var(--space-20);
      margin-bottom: var(--space-16);
    }

    .snapshot-card h3 {
      margin: 0 0 var(--space-12) 0;
      color: var(--color-text);
      font-size: var(--font-size-xl);
    }

    .report-section {
      margin-bottom: var(--space-24);
      padding: var(--space-16);
      background: var(--color-surface);
      border-radius: var(--radius-base);
      border: 1px solid var(--color-card-border);
    }

    .report-section h3 {
      font-size: var(--font-size-lg);
      margin: 0 0 var(--space-12) 0;
      color: var(--color-text);
    }

    #monthly-report-display ul, #yearly-report-display ul {
      list-style: none;
      padding: 0;
      margin: var(--space-8) 0;
    }

    #monthly-report-display ul li, #yearly-report-display ul li {
      padding: var(--space-8) 0;
      border-bottom: 1px solid var(--color-card-border);
    }

    #monthly-report-display ul li:last-child, #yearly-report-display ul li:last-child {
      border-bottom: none;
    }

    .health-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--space-8);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-8);
    }

    .health-message {
      font-size: var(--font-size-md);
      color: var(--color-text-secondary);
    }

    @media (max-width: 768px) {
      .financial-health > div > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
      }
    }
  
    .rub-value-display {
      min-width:120px;
      display:inline-block;
      background: var(--color-bg-8);
      color: var(--color-primary);
      font-weight: 600;
      font-size: 1.15em;
      border-radius: var(--radius-md);
      text-align: right;
      padding: 4px 11px;
      box-shadow: 0 2px 8px rgba(33,128,141,0.04);
      margin-left: 4px;
      transition: background 0.25s;
    }
    .rub-value-display[data-error="1"] {
      background: var(--color-bg-4);
      color: var(--color-error);
    }
</style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <h1 class="app-title">üí∞ Cashflow Tracker</h1>
      <p class="app-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—á–Ω—ã–º–∏ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏</p>
    </header>

    <nav class="tabs">
      <button class="tab-button active" data-tab="summary">üìä –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –û–±–∑–æ—Ä</button>
      <button class="tab-button" data-tab="income-expenses">üíµ –î–æ—Ö–æ–¥—ã –∏ –†–∞—Å—Ö–æ–¥—ã</button>
      <button class="tab-button" data-tab="assets-liabilities">üè¶ –ê–∫—Ç–∏–≤—ã –∏ –ü–∞—Å—Å–∏–≤—ã</button>
      
      <button class="tab-button" data-tab="cashflow">üìà –ö–µ—à—Ñ–ª–æ—É</button>
      <button class="tab-button" data-tab="reports">üìë –ì–æ–¥–æ–≤–æ–π –æ—Ç—á–µ—Ç</button>
    </nav>

    <!-- Storage Status & Export Controls -->
    <div style="max-width: 1200px; margin: 0 auto var(--space-16); text-align: center;">
      <div style="display: inline-flex; align-items: center; gap: var(--space-12); padding: var(--space-8) var(--space-16); background: var(--color-bg-3); border: 1px solid var(--color-card-border); border-radius: var(--radius-full); font-size: var(--font-size-sm);">
        <span id="storage-status" style="color: var(--color-success); font-weight: var(--font-weight-medium);">üíæ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ</span>
        <span style="color: var(--color-border);">|</span>
        <button onclick="exportDataAsJSON()" style="background: none; border: none; color: var(--color-primary); cursor: pointer; font-weight: var(--font-weight-medium); padding: 0;">üì• –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <span style="color: var(--color-border);">|</span>
        <label style="color: var(--color-primary); cursor: pointer; font-weight: var(--font-weight-medium);">
          üì§ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
          <input type="file" id="import-file-input" accept=".json" style="display: none;" onchange="if(this.files[0]) importDataFromJSON(this.files[0]);">
        </label>
      </div>
    </div>

    <!-- Month Selector - appears on all main tabs -->
    <div id="month-selector" style="max-width: 1200px; margin: 0 auto var(--space-24); padding: var(--space-16); background: var(--color-surface); border: 1px solid var(--color-card-border); border-radius: var(--radius-lg); display: flex; justify-content: space-between; align-items: center; gap: var(--space-16); flex-wrap: wrap;">
      <div style="display: flex; align-items: center; gap: var(--space-12);">
        <button class="btn btn-primary" onclick="navigateMonth(-1)" style="padding: var(--space-8) var(--space-16);">‚Üê –ù–∞–∑–∞–¥</button>
        <div style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); min-width: 200px; text-align: center;" id="current-month-display">–î–µ–∫–∞–±—Ä—å 2025</div>
        <button class="btn btn-primary" onclick="navigateMonth(1)" style="padding: var(--space-8) var(--space-16);">–í–ø–µ—Ä–µ–¥ ‚Üí</button>
      </div>
      <div style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">
        <span id="month-status-indicator">–†–∞–±–æ—Ç–∞–µ—Ç–µ —Å —Ç–µ–∫—É—â–∏–º –º–µ—Å—è—Ü–µ–º</span>
      </div>
    </div>

    <main class="content">
      <!-- Summary View -->
      <div id="summary-view" class="view active">
        <div class="summary-cards">
          <div class="summary-card">
            <div class="summary-label">–ß–∏—Å—Ç—ã–π –ö–∞–ø–∏—Ç–∞–ª</div>
            <div class="summary-value" id="summary-net-worth">0 ‚ÇΩ</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">–ú–µ—Å—è—á–Ω—ã–π –î–æ—Ö–æ–¥</div>
            <div class="summary-value positive" id="summary-income">0 ‚ÇΩ</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">–ú–µ—Å—è—á–Ω—ã–µ –†–∞—Å—Ö–æ–¥—ã</div>
            <div class="summary-value negative" id="summary-expenses">0 ‚ÇΩ</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">–ö–µ—à—Ñ–ª–æ—É</div>
            <div class="summary-value" id="summary-cashflow">0 ‚ÇΩ</div>
          </div>
        </div>

        <div class="grid grid-2">
          <div class="card">
            <h2 class="card-title">–ë–∞–ª–∞–Ω—Å –∞–∫—Ç–∏–≤–æ–≤ –∏ –ø–∞—Å—Å–∏–≤–æ–≤</h2>
            <div style="margin-bottom: var(--space-16);">
              <div class="total-row">
                <span>–ê–∫—Ç–∏–≤—ã:</span>
                <span class="positive" id="summary-assets-value">0 ‚ÇΩ</span>
              </div>
              <div class="total-row">
                <span>–ü–∞—Å—Å–∏–≤—ã:</span>
                <span class="negative" id="summary-liabilities-value">0 ‚ÇΩ</span>
              </div>
              <div class="total-row" style="border-top: 2px solid var(--color-border); padding-top: var(--space-12); margin-top: var(--space-12);">
                <span style="font-weight: var(--font-weight-bold);">–†–∞–∑–Ω–∏—Ü–∞:</span>
                <span id="summary-net-worth-diff" style="font-weight: var(--font-weight-bold); color: var(--color-primary);">0 ‚ÇΩ</span>
              </div>
            </div>
          </div>
          <div class="card">
            <h2 class="card-title">–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –¥–µ–Ω–µ–∂–Ω—ã–π –ø–æ—Ç–æ–∫</h2>
            <div style="margin-bottom: var(--space-16);">
              <div class="total-row">
                <span>–î–æ—Ö–æ–¥—ã –æ—Ç –∞–∫—Ç–∏–≤–æ–≤:</span>
                <span class="positive" id="summary-asset-income">+0.00 ‚ÇΩ</span>
              </div>
              <div class="total-row">
                <span>–†–∞—Å—Ö–æ–¥—ã –ø–æ –ø–∞—Å—Å–∏–≤–∞–º:</span>
                <span class="negative" id="summary-liability-expense">-0.00 ‚ÇΩ</span>
              </div>
              <div class="total-row" style="border-top: 2px solid var(--color-border); padding-top: var(--space-12); margin-top: var(--space-12);">
                <span style="font-weight: var(--font-weight-bold);">–†–∞–∑–Ω–∏—Ü–∞:</span>
                <span id="summary-monthly-diff" style="font-weight: var(--font-weight-bold); color: var(--color-primary);">0.00 ‚ÇΩ/–º–µ—Å.</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Income/Expenses View -->
      <div id="income-expenses-view" class="view">
        <div class="grid grid-2">
          <div class="card">
            <h2 class="card-title" id="income-form-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –î–æ—Ö–æ–¥</h2>
            <form id="income-form">
              <div class="form-group">
                <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select class="form-control" id="income-category" required>
                  <option value="–ó–∞—Ä–ø–ª–∞—Ç–∞">–ó–∞—Ä–ø–ª–∞—Ç–∞</option>
                  <option value="–§—Ä–∏–ª–∞–Ω—Å">–§—Ä–∏–ª–∞–Ω—Å</option>
                  <option value="–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</option>
                  <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <input type="text" class="form-control" id="income-description" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞—Ä–ø–ª–∞—Ç–∞ –∑–∞ –Ω–æ—è–±—Ä—å">
              </div>
              <div class="form-group">
  <label class="form-label">–°—É–º–º–∞ –∏ –≤–∞–ª—é—Ç–∞</label>
  <div style="display:flex;align-items:center;gap:12px;">
    <input type="number" class="form-control" id="income-amount" placeholder="10000" required min="0" step="0.01" style="max-width:130px;">
    <select class="form-control" id="income-currency" style="max-width:130px;" required></select>
    <span id="income-rub-value-display" class="rub-value-display"></span>
  </div>
</div>
              
              <div style="display: flex; align-items: center; gap: var(--space-8);">
                <button type="submit" class="btn btn-primary" id="income-submit-btn">‚úì –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</button>
                <button type="button" class="btn btn-cancel" id="income-cancel-btn" style="display: none;" onclick="cancelEditIncome()">–û—Ç–º–µ–Ω–∞</button>
              </div>
            </form>

            <div class="entries-list" id="income-list"></div>

            <div class="totals">
              <div class="total-row main">
                <span>–í—Å–µ–≥–æ –¥–æ—Ö–æ–¥–æ–≤:</span>
                <span class="positive" id="total-income">0 ‚ÇΩ</span>
              </div>
            </div>
          </div>

          <div class="card">
            <h2 class="card-title" id="expense-form-title">‚ûñ –î–æ–±–∞–≤–∏—Ç—å –†–∞—Å—Ö–æ–¥</h2>
            <form id="expense-form">
              <div class="form-group">
                <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select class="form-control" id="expense-category" required>
                  <option value="–ï–¥–∞">–ï–¥–∞</option>
                  <option value="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
                  <option value="–†–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ</option>
                  <option value="–ñ–∏–ª—å–µ">–ñ–∏–ª—å–µ</option>
                  <option value="–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                  <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <input type="text" class="form-control" id="expense-description" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–∫—É–ø–∫–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ">
              </div>
              <div class="form-group">
  <label class="form-label">–°—É–º–º–∞ –∏ –≤–∞–ª—é—Ç–∞</label>
  <div style="display:flex;align-items:center;gap:12px;">
    <input type="number" class="form-control" id="expense-amount" placeholder="5000" required min="0" step="0.01" style="max-width:130px;">
    <select class="form-control" id="expense-currency" style="max-width:130px;" required></select>
    <span id="expense-rub-value-display" class="rub-value-display"></span>
  </div>
</div>
              
              <div style="display: flex; align-items: center; gap: var(--space-8);">
                <button type="submit" class="btn btn-primary" id="expense-submit-btn">‚úì –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
                <button type="button" class="btn btn-cancel" id="expense-cancel-btn" style="display: none;" onclick="cancelEditExpense()">–û—Ç–º–µ–Ω–∞</button>
              </div>
            </form>

            <div class="entries-list" id="expense-list"></div>

            <div class="totals">
              <div class="total-row main">
                <span>–í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤:</span>
                <span class="negative" id="total-expenses">0 ‚ÇΩ</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top: var(--space-24);">
          <div class="total-row main">
            <span>–†–∞–∑–Ω–∏—Ü–∞ (–î–æ—Ö–æ–¥—ã - –†–∞—Å—Ö–æ–¥—ã):</span>
            <span id="income-expense-diff">0 ‚ÇΩ</span>
          </div>
        </div>
      </div>

      <!-- Assets/Liabilities View -->
      <div id="assets-liabilities-view" class="view">
        <div class="grid grid-2">
          <div class="card">
            <h2 class="card-title" id="asset-form-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ê–∫—Ç–∏–≤</h2>
            <div class="form-group">
                <label class="form-label">–¢–∏–ø</label>
                <select class="form-control" id="asset-type" required>
                  <option value="–ù–∞–ª–∏—á–Ω—ã–µ">–ù–∞–ª–∏—á–Ω—ã–µ</option>
                  <option value="–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π —Å—á—ë—Ç">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π —Å—á—ë—Ç</option>
                  <option value="–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å">–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</option>
                  <option value="–ê–∫—Ü–∏–∏">–ê–∫—Ü–∏–∏</option>
                  <option value="–ö—Ä–∏–ø—Ç–æ">–ö—Ä–∏–ø—Ç–æ</option>
                  <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" class="form-control" id="asset-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–≤–∞—Ä—Ç–∏—Ä–∞" required>
              </div>
              <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="text" class="form-control" id="asset-description" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Å–Ω–æ–≤–Ω–æ–π —Å—á–µ—Ç –¥–ª—è —Å–±–µ—Ä–µ–∂–µ–Ω–∏–π">
              </div>
            <form id="asset-form">
              
              <div class="form-group">
  <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –∏ –≤–∞–ª—é—Ç–∞</label>
  <div style="display:flex;align-items:center;gap:12px;">
    <input type="number" class="form-control" id="asset-value" placeholder="5000000" required min="0" step="0.01" style="max-width:160px;">
    <select class="form-control" id="asset-currency" style="max-width:130px;" required></select>
    <span id="asset-rub-value-display" class="rub-value-display"></span>
  </div>
</div>
              
              <div class="form-group">
                <label class="form-label">–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥</label>
                <div style="display: flex; gap: var(--space-8); margin-bottom: var(--space-8);">
                  <button type="button" class="btn btn-primary" id="asset-income-fixed-btn" onclick="toggleAssetIncomeType('fixed')">–§–∏–∫—Å. —Å—É–º–º–∞</button>
                  <button type="button" class="btn btn-primary" id="asset-income-percent-btn" onclick="toggleAssetIncomeType('percent')" style="background: var(--color-secondary); color: var(--color-text);">–ü—Ä–æ—Ü–µ–Ω—Ç –≥–æ–¥–æ–≤—ã—Ö</button>
                </div>
                <div id="asset-income-fixed-input">
  <div style="display:flex;align-items:center;gap:12px;">
    <input type="number" class="form-control" id="asset-monthly-income" placeholder="5000" min="0" step="0.01" style="max-width:120px;">
    <select class="form-control" id="asset-monthly-income-currency" style="max-width:110px;">
      <!-- currency will be populated by JS -->
    </select>
    <span id="asset-income-rub-value-display" class="rub-value-display"></span>
    <span style="color:var(--color-text-secondary);">‚ÇΩ/–º–µ—Å.</span>
  </div>
</div>
                <div id="asset-income-percent-input" style="display: none;">
                  <input type="number" class="form-control" id="asset-yearly-percent" placeholder="5% –≥–æ–¥–æ–≤—ã—Ö" min="0" step="0.01">
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: var(--space-8);">
                <button type="submit" class="btn btn-primary" id="asset-submit-btn">‚úì –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤</button>
                <button type="button" class="btn btn-cancel" id="asset-cancel-btn" style="display: none;" onclick="cancelEditAsset()">–û—Ç–º–µ–Ω–∞</button>
              </div>
            </form>

            <div class="entries-list" id="asset-list"></div>

            <div class="totals">
              <div class="total-row main">
                <span>–í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–æ–≤:</span>
                <span class="positive" id="total-assets">0 ‚ÇΩ</span>
              </div>
            </div>
          </div>

          <div class="card">
            <h2 class="card-title" id="liability-form-title">‚ûñ –î–æ–±–∞–≤–∏—Ç—å –ü–∞—Å—Å–∏–≤</h2>
            
            <div class="form-group">
                <label class="form-label">–¢–∏–ø</label>
                <select class="form-control" id="liability-type" required>
                  <option value="–ö—Ä–µ–¥–∏—Ç">–ö—Ä–µ–¥–∏—Ç</option>
                  <option value="–ò–ø–æ—Ç–µ–∫–∞">–ò–ø–æ—Ç–µ–∫–∞</option>
                  <option value="–î–æ–ª–≥">–î–æ–ª–≥</option>
                  <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" class="form-control" id="liability-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–ø–æ—Ç–µ–∫–∞" required>
              </div>
              <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="text" class="form-control" id="liability-description" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–ø–æ—Ç–µ–∫–∞ –Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä—É">
              </div>
              <div class="form-group">
            <form id="liability-form">
              
              <div class="form-group">
  <label class="form-label">–°—É–º–º–∞ –∏ –≤–∞–ª—é—Ç–∞</label>
  <div style="display:flex;align-items:center;gap:12px;">
    <input type="number" class="form-control" id="liability-amount" placeholder="2000000" required min="0" step="0.01" style="max-width:155px;">
    <select class="form-control" id="liability-currency" style="max-width:120px;" required></select>
    <span id="liability-rub-value-display" class="rub-value-display"></span>
  </div>
</div>
              <div class="form-group">
                <label class="form-label">–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ (%)</label>
                <input type="number" class="form-control" id="liability-rate" placeholder="8.5" step="0.01" min="0">
              </div>
              
  <label class="form-label">–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π —Ä–∞—Å—Ö–æ–¥</label>
  <div style="display:flex;align-items:center;gap:12px;">
    <input type="number" class="form-control" id="liability-monthly-expense" placeholder="50000" min="0" step="0.01" style="max-width:120px;">
    <select class="form-control" id="liability-monthly-expense-currency" style="max-width:110px;">
      <!-- currency will be populated by JS -->
    </select>
    <span id="liability-expense-rub-value-display" class="rub-value-display"></span>
    <span style="color:var(--color-text-secondary);">‚ÇΩ/–º–µ—Å.</span>
  </div>
  <small style="color: var(--color-text-secondary); font-size: var(--font-size-xs); margin-top: var(--space-4); display: block;">–£–∫–∞–∂–∏—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π –ø–ª–∞—Ç—ë–∂ –ø–æ –∫—Ä–µ–¥–∏—Ç—É</small>
</div>
              <div style="display: flex; align-items: center; gap: var(--space-8);">
                <button type="submit" class="btn btn-primary" id="liability-submit-btn">‚úì –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Å—Å–∏–≤</button>
                <button type="button" class="btn btn-cancel" id="liability-cancel-btn" style="display: none;" onclick="cancelEditLiability()">–û—Ç–º–µ–Ω–∞</button>
              </div>
            </form>

            <div class="entries-list" id="liability-list"></div>

            <div class="totals">
              <div class="total-row main">
                <span>–í—Å–µ–≥–æ –ø–∞—Å—Å–∏–≤–æ–≤:</span>
                <span class="negative" id="total-liabilities">0 ‚ÇΩ</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top: var(--space-24);">
          <div class="total-row main">
            <span>–ß–∏—Å—Ç—ã–π –ö–∞–ø–∏—Ç–∞–ª (–ê–∫—Ç–∏–≤—ã - –ü–∞—Å—Å–∏–≤—ã):</span>
            <span id="net-worth">0 ‚ÇΩ</span>
          </div>
        </div>
      </div>

      <!-- Recurring Payments View -->
      <div id="recurring-view" class="view">
        <div class="grid grid-2">
          <div class="card">
            <h2 class="card-title" id="recurring-income-form-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –¥–æ—Ö–æ–¥</h2>
            <form id="recurring-income-form">
              <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" class="form-control" id="recurring-income-name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞—Ä–ø–ª–∞—Ç–∞">
              </div>
              <div class="form-group">
  <label class="form-label">–°—É–º–º–∞ –∏ –≤–∞–ª—é—Ç–∞</label>
  <div style="display:flex;align-items:center;gap:12px;">
    <input type="number" class="form-control" id="recurring-income-amount" required min="0" step="0.01" placeholder="10000" style="max-width:120px;">
    <select class="form-control" id="recurring-income-currency" style="max-width:110px;" required></select>
    <span id="recurring-income-rub-value-display" class="rub-value-display"></span>
  </div>
</div>
              <div class="form-group">
                <label class="form-label">–ß–∞—Å—Ç–æ—Ç–∞</label>
                <select class="form-control" id="recurring-income-frequency">
                  <option value="–ï–∂–µ–º–µ—Å—è—á–Ω–æ">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
                  <option value="–ï–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ">–ï–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ</option>
                  <option value="–ï–∂–µ–≥–æ–¥–Ω–æ">–ï–∂–µ–≥–æ–¥–Ω–æ</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="text" class="form-control" id="recurring-income-description" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞">
              </div>
              <div style="display: flex; align-items: center; gap: var(--space-8);">
                <button type="submit" class="btn btn-primary" id="recurring-income-submit-btn">‚úì –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</button>
                <button type="button" class="btn btn-cancel" id="recurring-income-cancel-btn" style="display: none;" onclick="cancelEditRecurringIncome()">–û—Ç–º–µ–Ω–∞</button>
              </div>
            </form>

            <div class="entries-list" id="recurring-income-list"></div>
            <div class="totals">
              <div class="total-row main">
                <span>–í—Å–µ–≥–æ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –¥–æ—Ö–æ–¥–æ–≤/–º–µ—Å.:</span>
                <span class="positive" id="total-recurring-income">0 ‚ÇΩ</span>
              </div>
            </div>
          </div>
          <div class="card">
            <h2 class="card-title" id="recurring-expense-form-title">‚ûñ –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Ä–∞—Å—Ö–æ–¥</h2>
            <form id="recurring-expense-form">
              <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" class="form-control" id="recurring-expense-name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–¥–ø–∏—Å–∫–∞">
              </div>
              <div class="form-group">
  <label class="form-label">–°—É–º–º–∞ –∏ –≤–∞–ª—é—Ç–∞</label>
  <div style="display:flex;align-items:center;gap:12px;">
    <input type="number" class="form-control" id="recurring-expense-amount" required min="0" step="0.01" placeholder="5000" style="max-width:120px;">
    <select class="form-control" id="recurring-expense-currency" style="max-width:110px;" required></select>
    <span id="recurring-expense-rub-value-display" class="rub-value-display"></span>
  </div>
</div>
              <div class="form-group">
                <label class="form-label">–ß–∞—Å—Ç–æ—Ç–∞</label>
                <select class="form-control" id="recurring-expense-frequency">
                  <option value="–ï–∂–µ–º–µ—Å—è—á–Ω–æ">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
                  <option value="–ï–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ">–ï–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ</option>
                  <option value="–ï–∂–µ–≥–æ–¥–Ω–æ">–ï–∂–µ–≥–æ–¥–Ω–æ</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="text" class="form-control" id="recurring-expense-description" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Netflix –ø–æ–¥–ø–∏—Å–∫–∞">
              </div>
              <div style="display: flex; align-items: center; gap: var(--space-8);">
                <button type="submit" class="btn btn-primary" id="recurring-expense-submit-btn">‚úì –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
                <button type="button" class="btn btn-cancel" id="recurring-expense-cancel-btn" style="display: none;" onclick="cancelEditRecurringExpense()">–û—Ç–º–µ–Ω–∞</button>
              </div>
            </form>

            <div class="entries-list" id="recurring-expense-list"></div>
            <div class="totals">
              <div class="total-row main">
                <span>–í—Å–µ–≥–æ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤/–º–µ—Å.:</span>
                <span class="negative" id="total-recurring-expense">0 ‚ÇΩ</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Reports View - Monthly & Annual Overview -->
      <div id="reports-view" class="view">
        <!-- Report Type Tabs -->
        <div style="display: flex; gap: var(--space-8); justify-content: center; margin-bottom: var(--space-24);">
          <button class="btn btn-primary" id="monthly-report-btn" onclick="switchReportType('monthly')" style="padding: var(--space-12) var(--space-24);">üìÑ –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç</button>
          <button class="btn btn-primary" id="yearly-report-btn" onclick="switchReportType('yearly')" style="background: var(--color-secondary); color: var(--color-text); padding: var(--space-12) var(--space-24);">üìÖ –ì–æ–¥–æ–≤–æ–π –æ–±–∑–æ—Ä</button>
        </div>

        <!-- Monthly Report View -->
        <div id="monthly-report-container" class="card">
          <div id="monthly-report-content"></div>
        </div>

        <!-- Yearly Report View -->
        <div id="yearly-report-container" class="card" style="display: none;">
          <h2 class="card-title">üìÖ –ì–æ–¥–æ–≤–æ–π –æ—Ç—á–µ—Ç</h2>
          <div id="year-selector" style="display: flex; justify-content: center; align-items: center; gap: var(--space-16); margin-bottom: var(--space-24);">
            <button class="btn btn-primary" onclick="changeReportYear(-1)">‚Üê –ù–∞–∑–∞–¥</button>
            <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); min-width: 200px; text-align: center;" id="report-year-display">2025</div>
            <button class="btn btn-primary" onclick="changeReportYear(1)">–í–ø–µ—Ä–µ–¥ ‚Üí</button>
          </div>
          <div id="year-overview"></div>
        </div>
      </div>

      <!-- Cashflow View -->
      <div id="cashflow-view" class="view">
        <div class="cashflow-chart">
          <h2 class="card-title">–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ö–µ—à—Ñ–ª–æ—É</h2>
          <div class="cashflow-bars" id="cashflow-bars">
            <div class="cashflow-bar">
              <div class="bar" id="income-bar" style="height: 0;">
                <div class="bar-value" id="income-bar-value">0 ‚ÇΩ</div>
              </div>
              <div class="bar-label">–î–æ—Ö–æ–¥—ã</div>
            </div>
            <div class="cashflow-bar">
              <div class="bar expense" id="expense-bar" style="height: 0;">
                <div class="bar-value" id="expense-bar-value">0 ‚ÇΩ</div>
              </div>
              <div class="bar-label">–†–∞—Å—Ö–æ–¥—ã</div>
            </div>
          </div>
        </div>

        <div class="grid grid-2">
          <div class="card">
            <h2 class="card-title">–û—Ç—á–µ—Ç –æ –î–≤–∏–∂–µ–Ω–∏–∏ –î–µ–Ω–µ–∂–Ω—ã—Ö –°—Ä–µ–¥—Å—Ç–≤</h2>
            <div class="total-row">
              <span>–î–æ—Ö–æ–¥—ã:</span>
              <span class="positive" id="cf-income">0 ‚ÇΩ</span>
            </div>
            <div class="total-row">
              <span>–†–∞—Å—Ö–æ–¥—ã:</span>
              <span class="negative" id="cf-expenses">0 ‚ÇΩ</span>
            </div>
            <div class="total-row main">
              <span>–ú–µ—Å—è—á–Ω—ã–π –ö–µ—à—Ñ–ª–æ—É:</span>
              <span id="cf-result">0 ‚ÇΩ</span>
            </div>
          </div>

          <div class="card">
            <h2 class="card-title">–ê–Ω–∞–ª–∏–∑ –†–∞—Å—Ö–æ–¥–æ–≤</h2>
            <div class="total-row">
              <span>–ß–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥:</span>
              <span id="net-income-value">0 ‚ÇΩ</span>
            </div>
            <div class="total-row">
              <span>–ü—Ä–æ—Ü–µ–Ω—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤:</span>
              <span id="expense-percentage">0%</span>
            </div>
            <div class="total-row">
              <span>–ù–æ—Ä–º–∞ —Å–±–µ—Ä–µ–∂–µ–Ω–∏–π:</span>
              <span id="savings-rate">0%</span>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Data storage - restructured for independent months
    let monthlyData = {}; // {year: {month: {incomes, expenses, assets, liabilities, recurring}}}
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let reportType = 'monthly';
    let nextId = 1;
    
    // IndexedDB Configuration
    const DB_NAME = 'CashflowTrackerDB';
    const DB_VERSION = 1;
    let db = null;
    let dbAvailable = true;
    
    // Helper to get current month data
    function getCurrentMonthData() {
      if (!monthlyData[currentYear]) monthlyData[currentYear] = {};
      if (!monthlyData[currentYear][currentMonth]) {
        monthlyData[currentYear][currentMonth] = {
          incomes: [],
          expenses: [],
          assets: [],
          liabilities: [],
          recurringIncomes: [],
          recurringExpenses: []
        };
      }
      return monthlyData[currentYear][currentMonth];
    }
    
    // Getters for current month's data
    function getIncomes() { return getCurrentMonthData().incomes; }
    function getExpenses() { return getCurrentMonthData().expenses; }
    function getAssets() { return getCurrentMonthData().assets; }
    function getLiabilities() { return getCurrentMonthData().liabilities; }
    function getRecurringIncomes() { return getCurrentMonthData().recurringIncomes; }
    function getRecurringExpenses() { return getCurrentMonthData().recurringExpenses; }

    // Edit state tracking
    let editingIncome = null;
    let editingExpense = null;
    let editingAsset = null;
    let editingLiability = null;
    let editingRecurringIncome = null;
    let editingRecurringExpense = null;
    
    // Month navigation functions
    function navigateMonth(offset) {
      currentMonth += offset;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      updateMonthDisplay();
      refreshAllViews();
      autoSaveSettings();
    }
    
    function updateMonthDisplay() {
      const monthNames = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
      document.getElementById('current-month-display').textContent = `${monthNames[currentMonth]} ${currentYear}`;
      
      const data = getCurrentMonthData();
      const hasData = data.incomes.length > 0 || data.expenses.length > 0 || data.assets.length > 0 || data.liabilities.length > 0;
      document.getElementById('month-status-indicator').textContent = hasData ? 
        `–ú–µ—Å—è—Ü —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ` : `–ú–µ—Å—è—Ü –ø—É—Å—Ç. –ù–∞—á–Ω–∏—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ.`;
    }
    
    function refreshAllViews() {
      // Cancel any active edits
      if (editingIncome) cancelEditIncome();
      if (editingExpense) cancelEditExpense();
      if (editingAsset) cancelEditAsset();
      if (editingLiability) cancelEditLiability();
      if (editingRecurringIncome) cancelEditRecurringIncome();
      if (editingRecurringExpense) cancelEditRecurringExpense();
      
      // Update all lists and totals
      updateIncomeList();
      updateExpenseList();
      updateAssetList();
      updateLiabilityList();
      updateRecurringLists();
      updateTotals();
    }

    // ========== INDEXEDDB PERSISTENCE LAYER ==========
    
    // Initialize IndexedDB
    async function initIndexedDB() {
      return new Promise((resolve, reject) => {
        try {
          const request = indexedDB.open(DB_NAME, DB_VERSION);
          
          request.onerror = () => {
            console.warn('IndexedDB not available, using in-memory storage');
            dbAvailable = false;
            resolve(false);
          };
          
          request.onsuccess = (event) => {
            db = event.target.result;
            console.log('IndexedDB initialized successfully');
            resolve(true);
          };
          
          request.onupgradeneeded = (event) => {
            db = event.target.result;
            
            // Create object stores
            if (!db.objectStoreNames.contains('monthlyData')) {
              db.createObjectStore('monthlyData', { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains('exchangeRates')) {
              db.createObjectStore('exchangeRates', { keyPath: 'timestamp' });
            }
            if (!db.objectStoreNames.contains('settings')) {
              db.createObjectStore('settings', { keyPath: 'key' });
            }
          };
        } catch (error) {
          console.warn('IndexedDB error:', error);
          dbAvailable = false;
          resolve(false);
        }
      });
    }
    
    // Save data to IndexedDB
    async function saveToIndexedDB(storeName, data) {
      if (!dbAvailable || !db) return false;
      
      return new Promise((resolve) => {
        try {
          const transaction = db.transaction([storeName], 'readwrite');
          const store = transaction.objectStore(storeName);
          const request = store.put(data);
          
          request.onsuccess = () => resolve(true);
          request.onerror = () => resolve(false);
        } catch (error) {
          console.warn('IndexedDB save error:', error);
          resolve(false);
        }
      });
    }
    
    // Load data from IndexedDB
    async function loadFromIndexedDB(storeName, key) {
      if (!dbAvailable || !db) return null;
      
      return new Promise((resolve) => {
        try {
          const transaction = db.transaction([storeName], 'readonly');
          const store = transaction.objectStore(storeName);
          const request = store.get(key);
          
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => resolve(null);
        } catch (error) {
          console.warn('IndexedDB load error:', error);
          resolve(null);
        }
      });
    }
    
    // Load all data from a store
    async function loadAllFromIndexedDB(storeName) {
      if (!dbAvailable || !db) return [];
      
      return new Promise((resolve) => {
        try {
          const transaction = db.transaction([storeName], 'readonly');
          const store = transaction.objectStore(storeName);
          const request = store.getAll();
          
          request.onsuccess = () => resolve(request.result || []);
          request.onerror = () => resolve([]);
        } catch (error) {
          console.warn('IndexedDB loadAll error:', error);
          resolve([]);
        }
      });
    }
    
    // Delete from IndexedDB
    async function deleteFromIndexedDB(storeName, key) {
      if (!dbAvailable || !db) return false;
      
      return new Promise((resolve) => {
        try {
          const transaction = db.transaction([storeName], 'readwrite');
          const store = transaction.objectStore(storeName);
          const request = store.delete(key);
          
          request.onsuccess = () => resolve(true);
          request.onerror = () => resolve(false);
        } catch (error) {
          console.warn('IndexedDB delete error:', error);
          resolve(false);
        }
      });
    }
    
    // Auto-save all monthly data
    async function autoSaveMonthlyData() {
      await saveToIndexedDB('monthlyData', {
        id: 'allMonths',
        data: monthlyData,
        lastUpdated: Date.now()
      });
    }
    
    // Auto-save current month and year
    async function autoSaveSettings() {
      await saveToIndexedDB('settings', {
        key: 'currentView',
        month: currentMonth,
        year: currentYear,
        lastUpdated: Date.now()
      });
      await saveToIndexedDB('settings', {
        key: 'nextId',
        value: nextId,
        lastUpdated: Date.now()
      });
    }
    
    // Restore all data from IndexedDB
    async function restoreDataFromIndexedDB() {
      // Restore monthly data
      const monthlyDataRecord = await loadFromIndexedDB('monthlyData', 'allMonths');
      if (monthlyDataRecord && monthlyDataRecord.data) {
        monthlyData = monthlyDataRecord.data;
        console.log('Restored monthly data from IndexedDB');
      }
      
      // Restore settings
      const settingsRecord = await loadFromIndexedDB('settings', 'currentView');
      if (settingsRecord) {
        currentMonth = settingsRecord.month;
        currentYear = settingsRecord.year;
        console.log('Restored current month/year from IndexedDB');
      }
      
      const nextIdRecord = await loadFromIndexedDB('settings', 'nextId');
      if (nextIdRecord) {
        nextId = nextIdRecord.value;
        console.log('Restored nextId from IndexedDB');
      }
      
      // Restore exchange rates
      const ratesRecord = await loadFromIndexedDB('exchangeRates', 'current');
      if (ratesRecord && ratesRecord.rates) {
        const age = Date.now() - ratesRecord.timestamp;
        const MAX_AGE = 24 * 60 * 60 * 1000; // 24 hours
        
        if (age < MAX_AGE) {
          exchangeRates = ratesRecord.rates;
          ratesLastUpdated = new Date(ratesRecord.timestamp);
          ratesStatus = 'cached';
          console.log('Using cached exchange rates');
        }
      }
    }
    
    // Save exchange rates to cache
    async function cacheExchangeRates() {
      await saveToIndexedDB('exchangeRates', {
        timestamp: Date.now(),
        rates: exchangeRates,
        lastUpdated: ratesLastUpdated
      });
    }
    
    // Export all data as JSON
    function exportDataAsJSON() {
      const exportData = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        monthlyData: monthlyData,
        settings: {
          currentMonth,
          currentYear,
          nextId
        },
        exchangeRates: {
          rates: exchangeRates,
          lastUpdated: ratesLastUpdated
        }
      };
      
      const jsonStr = JSON.stringify(exportData, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dateStr = new Date().toISOString().split('T')[0];
      a.href = url;
      a.download = `cashflow_backup_${dateStr}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert('‚úÖ –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ!');
    }
    
    // Import data from JSON
    function importDataFromJSON(file) {
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const importData = JSON.parse(e.target.result);
          
          if (importData.monthlyData) {
            monthlyData = importData.monthlyData;
          }
          if (importData.settings) {
            currentMonth = importData.settings.currentMonth || currentMonth;
            currentYear = importData.settings.currentYear || currentYear;
            nextId = importData.settings.nextId || nextId;
          }
          
          await autoSaveMonthlyData();
          await autoSaveSettings();
          
          updateMonthDisplay();
          refreshAllViews();
          
          alert('‚úÖ –î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ!');
        } catch (error) {
          alert('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + error.message);
        }
      };
      reader.readAsText(file);
    }
    
    // ========== END INDEXEDDB LAYER ==========
    
    // Currency data
    const currencies = [
      {code: 'RUB', name: '–†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å', symbol: '‚ÇΩ'},
      {code: 'USD', name: '–î–æ–ª–ª–∞—Ä –°–®–ê', symbol: '$'},
      {code: 'EUR', name: '–ï–≤—Ä–æ', symbol: '‚Ç¨'},
      {code: 'GBP', name: '–ë—Ä–∏—Ç–∞–Ω—Å–∫–∏–π —Ñ—É–Ω—Ç', symbol: '¬£'},
      {code: 'JPY', name: '–Ø–ø–æ–Ω—Å–∫–∞—è –∏–µ–Ω–∞', symbol: '¬•'},
      {code: 'CNY', name: '–ö–∏—Ç–∞–π—Å–∫–∏–π —é–∞–Ω—å', symbol: '¬•'}
    ];
    const baseCurrency = 'RUB';
    let exchangeRates = {};
    let ratesLastUpdated = null;
    let ratesStatus = 'loading';

    // ========== RUB Value Calculation Logic for All Forms ==========

    function updateRubEquivalentDisplay(inputId, currencyId, displayId) {
      const input = document.getElementById(inputId);
      const currency = document.getElementById(currencyId);
      const display = document.getElementById(displayId);
      if (!input || !currency || !display) return;
      let val = parseFloat(input.value);
      let curr = currency.value;
      let error = false;
      let result = '';
      if (!input.value) {
        display.textContent = '‚ÇΩ';
        display.setAttribute('data-error', '0');
        return;
      }
      if (isNaN(val)) {
        display.textContent = '? ‚ÇΩ';
        display.setAttribute('data-error', '1');
        return;
      }
      try {
        let rub = convertToRub(val, curr);
        if (!rub || isNaN(rub)) {
          error = true;
          result = '? ‚ÇΩ';
        } else {
          result = formatNumber(rub) + ' ‚ÇΩ';
        }
      } catch {
        error = true;
        result = '? ‚ÇΩ';
      }
      display.textContent = result;
      display.setAttribute('data-error', error ? '1' : '0');
    }

    // Initialize form events for RUB conversion, run once after fields/currencies are rendered
    function initRubValueInputs() {
      // –î–æ—Ö–æ–¥
      document.getElementById('income-amount').addEventListener('input', ()=>updateRubEquivalentDisplay('income-amount','income-currency','income-rub-value-display'));
      document.getElementById('income-currency').addEventListener('change', ()=>updateRubEquivalentDisplay('income-amount','income-currency','income-rub-value-display'));
      // –†–∞—Å—Ö–æ–¥
      document.getElementById('expense-amount').addEventListener('input', ()=>updateRubEquivalentDisplay('expense-amount','expense-currency','expense-rub-value-display'));
      document.getElementById('expense-currency').addEventListener('change', ()=>updateRubEquivalentDisplay('expense-amount','expense-currency','expense-rub-value-display'));
      // –ê–∫—Ç–∏–≤
      document.getElementById('asset-value').addEventListener('input', ()=>updateRubEquivalentDisplay('asset-value','asset-currency','asset-rub-value-display'));
      document.getElementById('asset-currency').addEventListener('change', ()=>updateRubEquivalentDisplay('asset-value','asset-currency','asset-rub-value-display'));
      // –î–æ—Ö–æ–¥ –ø–æ –∞–∫—Ç–∏–≤—É (fixed)
      document.getElementById('asset-monthly-income').addEventListener('input', ()=>updateRubEquivalentDisplay('asset-monthly-income','asset-monthly-income-currency','asset-income-rub-value-display'));
      document.getElementById('asset-monthly-income-currency').addEventListener('change',()=>updateRubEquivalentDisplay('asset-monthly-income','asset-monthly-income-currency','asset-income-rub-value-display'));
      // –ü–∞—Å—Å–∏–≤
      document.getElementById('liability-amount').addEventListener('input',()=>updateRubEquivalentDisplay('liability-amount','liability-currency','liability-rub-value-display'));
      document.getElementById('liability-currency').addEventListener('change',()=>updateRubEquivalentDisplay('liability-amount','liability-currency','liability-rub-value-display'));
      // –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –ø–æ –ø–∞—Å—Å–∏–≤—É
      document.getElementById('liability-monthly-expense').addEventListener('input',()=>updateRubEquivalentDisplay('liability-monthly-expense','liability-monthly-expense-currency','liability-expense-rub-value-display'));
      document.getElementById('liability-monthly-expense-currency').addEventListener('change',()=>updateRubEquivalentDisplay('liability-monthly-expense','liability-monthly-expense-currency','liability-expense-rub-value-display'));
      // –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –¥–æ—Ö–æ–¥—ã
      document.getElementById('recurring-income-amount').addEventListener('input',()=>updateRubEquivalentDisplay('recurring-income-amount','recurring-income-currency','recurring-income-rub-value-display'));
      document.getElementById('recurring-income-currency').addEventListener('change',()=>updateRubEquivalentDisplay('recurring-income-amount','recurring-income-currency','recurring-income-rub-value-display'));
      // –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
      document.getElementById('recurring-expense-amount').addEventListener('input',()=>updateRubEquivalentDisplay('recurring-expense-amount','recurring-expense-currency','recurring-expense-rub-value-display'));
      document.getElementById('recurring-expense-currency').addEventListener('change',()=>updateRubEquivalentDisplay('recurring-expense-amount','recurring-expense-currency','recurring-expense-rub-value-display'));
    }

    // Tab navigation
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        const tabName = button.dataset.tab;
        
        // Update active tab button
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        // Update active view
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        document.getElementById(`${tabName}-view`).classList.add('active');
        
        // Update specific views
        if (tabName === 'cashflow') {
          updateCashflowView();
        } else if (tabName === 'summary') {
          updateSummaryView();
        } else if (tabName === 'recurring') {
          updateRecurringLists();
        }
      });
    });

    // Format number with spaces
    function formatNumber(num) {
      return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }

    // Get currency symbol
    function getCurrencySymbol(code) {
      const curr = currencies.find(c => c.code === code);
      return curr ? curr.symbol : code;
    }

    // Convert currency to RUB
    function convertToRub(amount, fromCurrency) {
      if (fromCurrency === 'RUB') return amount;
      const rate = exchangeRates[fromCurrency.toLowerCase()]?.rub || 1;
      return amount * rate;
    }

    // Fetch exchange rates from CBR
    async function fetchExchangeRates() {
      try {
        const response = await fetch('https://www.cbr-xml-daily.ru/daily_json.js');
        if (!response.ok) throw new Error('Failed to fetch rates');
        
        const data = await response.json();
        const valute = data.Valute;
        
        // Map CBR currency codes to our format
        const cbrMapping = {
          'usd': valute.USD?.Value || 1,
          'eur': valute.EUR?.Value || 1,
          'gbp': valute.GBP?.Value || 1,
          'jpy': valute.JPY?.Value || 1,
          'cny': valute.CNY?.Value || 1
        };
        
        // Store rates in our format
        exchangeRates = {};
        for (const [code, rate] of Object.entries(cbrMapping)) {
          exchangeRates[code] = { rub: rate };
        }
        
        ratesLastUpdated = new Date();
        ratesStatus = 'success';
        cacheExchangeRates();
        
        // Hide warning if visible
        const warning = document.getElementById('rates-warning');
        if (warning) warning.style.display = 'none';
        
      } catch (error) {
        console.warn('Failed to fetch exchange rates:', error);
        ratesStatus = 'error';
        
        // Show warning
        const warning = document.getElementById('rates-warning');
        if (warning) warning.style.display = 'block';
        
        // Use fallback rates (approximate)
        exchangeRates = {
          'usd': { rub: 100 },
          'eur': { rub: 110 },
          'gbp': { rub: 130 },
          'jpy': { rub: 0.65 },
          'cny': { rub: 14 }
        };
      }
      
      updateAllConversions();
    }

    // Update all conversions after rate changes
    function updateAllConversions() {
      // Recalculate all RUB equivalents for all months
      for (let year in monthlyData) {
        for (let month in monthlyData[year]) {
          const data = monthlyData[year][month];
          data.incomes.forEach(item => {
            item.amountInRub = convertToRub(item.amount, item.currency);
          });
          data.expenses.forEach(item => {
            item.amountInRub = convertToRub(item.amount, item.currency);
          });
          data.assets.forEach(item => {
            item.valueInRub = convertToRub(item.value, item.currency);
          });
          data.liabilities.forEach(item => {
            item.amountInRub = convertToRub(item.amount, item.currency);
          });
          data.recurringIncomes.forEach(item => {
            item.amountInRub = convertToRub(item.amount, item.currency);
          });
          data.recurringExpenses.forEach(item => {
            item.amountInRub = convertToRub(item.amount, item.currency);
          });
        }
      }
      
      // Update all displays
      updateIncomeList();
      updateExpenseList();
      updateAssetList();
      updateLiabilityList();
      updateRecurringLists();
      updateTotals();
    }

    // Generate currency options HTML
    function getCurrencyOptionsHtml(selectedCode = 'RUB') {
      return currencies.map(c => 
        `<option value="${c.code}" ${c.code === selectedCode ? 'selected' : ''}>${c.symbol} ${c.code} - ${c.name}</option>`
      ).join('');
    }

    // Helper: convert recurring frequency to monthly value
    function frequencyToMonthly(amount, frequency) {
      if (frequency === '–ï–∂–µ–º–µ—Å—è—á–Ω–æ') return amount;
      if (frequency === '–ï–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ') return amount / 3;
      if (frequency === '–ï–∂–µ–≥–æ–¥–Ω–æ') return amount / 12;
      return amount;
    }

    // Income form submission
    document.getElementById('income-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('income-amount').value);
      const currency = document.getElementById('income-currency').value;
      const category = document.getElementById('income-category').value;
      const description = document.getElementById('income-description').value;
      const amountInRub = convertToRub(amount, currency);
      
      if (editingIncome !== null) {
        // Update existing income
        const income = getIncomes().find(i => i.id === editingIncome);
        if (income) {
          income.amount = amount;
          income.currency = currency;
          income.amountInRub = amountInRub;
          income.category = category;
          income.description = description;
        }
        cancelEditIncome();
      } else {
        // Add new income
        getIncomes().push({
          id: nextId++,
          amount,
          currency,
          amountInRub,
          category,
          description
        });
        e.target.reset();
        document.getElementById('income-currency').innerHTML = getCurrencyOptionsHtml('RUB');
        updateRubEquivalentDisplay('income-amount','income-currency','income-rub-value-display');
      }
      
      updateIncomeList();
      updateTotals();
      autoSaveMonthlyData();
    });

    // Expense form submission
    document.getElementById('expense-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('expense-amount').value);
      const currency = document.getElementById('expense-currency').value;
      const category = document.getElementById('expense-category').value;
      const description = document.getElementById('expense-description').value;
      const amountInRub = convertToRub(amount, currency);
      
      if (editingExpense !== null) {
        // Update existing expense
        const expense = getExpenses().find(e => e.id === editingExpense);
        if (expense) {
          expense.amount = amount;
          expense.currency = currency;
          expense.amountInRub = amountInRub;
          expense.category = category;
          expense.description = description;
        }
        cancelEditExpense();
      } else {
        // Add new expense
        getExpenses().push({
          id: nextId++,
          amount,
          currency,
          amountInRub,
          category,
          description
        });
        e.target.reset();
        document.getElementById('expense-currency').innerHTML = getCurrencyOptionsHtml('RUB');
        updateRubEquivalentDisplay('expense-amount','expense-currency','expense-rub-value-display');
      }
      
      updateExpenseList();
      updateTotals();
      autoSaveMonthlyData();
    });

    let assetIncomeType = 'fixed';
    function toggleAssetIncomeType(type) {
      assetIncomeType = type;
      if (type === 'fixed') {
        document.getElementById('asset-income-fixed-input').style.display = 'block';
        document.getElementById('asset-income-percent-input').style.display = 'none';
        document.getElementById('asset-income-fixed-btn').style.background = 'var(--color-primary)';
        document.getElementById('asset-income-fixed-btn').style.color = 'var(--color-btn-primary-text)';
        document.getElementById('asset-income-percent-btn').style.background = 'var(--color-secondary)';
        document.getElementById('asset-income-percent-btn').style.color = 'var(--color-text)';
      } else {
        document.getElementById('asset-income-fixed-input').style.display = 'none';
        document.getElementById('asset-income-percent-input').style.display = 'block';
        document.getElementById('asset-income-percent-btn').style.background = 'var(--color-primary)';
        document.getElementById('asset-income-percent-btn').style.color = 'var(--color-btn-primary-text)';
        document.getElementById('asset-income-fixed-btn').style.background = 'var(--color-secondary)';
        document.getElementById('asset-income-fixed-btn').style.color = 'var(--color-text)';
      }
    }
    // Asset form submission
    document.getElementById('asset-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('asset-name').value;
      const value = parseFloat(document.getElementById('asset-value').value);
      const currency = document.getElementById('asset-currency').value;
      const type = document.getElementById('asset-type').value;
      const description = document.getElementById('asset-description').value || '';
      const valueInRub = convertToRub(value, currency);
      let monthlyIncome = 0;
      let monthlyIncomeOriginal = 0;
      let incomeCurrency = 'RUB';
      let incomeType = assetIncomeType;
      if (assetIncomeType === 'fixed') {
        monthlyIncomeOriginal = parseFloat(document.getElementById('asset-monthly-income').value) || 0;
        incomeCurrency = document.getElementById('asset-monthly-income-currency').value || 'RUB';
        monthlyIncome = convertToRub(monthlyIncomeOriginal, incomeCurrency);
      } else {
        const yearlyPercent = parseFloat(document.getElementById('asset-yearly-percent').value) || 0;
        monthlyIncome = (valueInRub * yearlyPercent / 100) / 12;
        monthlyIncomeOriginal = yearlyPercent;
        incomeCurrency = 'PERCENT';
      }
      
      if (editingAsset !== null) {
        // Update existing asset
        const asset = getAssets().find(a => a.id === editingAsset);
        if (asset) {
          asset.name = name;
          asset.value = value;
          asset.currency = currency;
          asset.valueInRub = valueInRub;
          asset.type = type;
          asset.description = description;
          asset.monthlyIncome = monthlyIncome;
          asset.monthlyIncomeOriginal = monthlyIncomeOriginal;
          asset.incomeCurrency = incomeCurrency;
          asset.incomeType = incomeType;
        }
        cancelEditAsset();
      } else {
        // Add new asset
        getAssets().push({
          id: nextId++,
          name,
          value,
          currency,
          valueInRub,
          type,
          description,
          monthlyIncome,
          monthlyIncomeOriginal,
          incomeCurrency,
          incomeType
        });
        e.target.reset();
        document.getElementById('asset-currency').innerHTML = getCurrencyOptionsHtml('RUB');
        document.getElementById('asset-monthly-income-currency').innerHTML = getCurrencyOptionsHtml('RUB');
        updateRubEquivalentDisplay('asset-value','asset-currency','asset-rub-value-display');
        updateRubEquivalentDisplay('asset-monthly-income','asset-monthly-income-currency','asset-income-rub-value-display');
      }
      
      updateAssetList();
      updateTotals();
      autoSaveMonthlyData();
    });

    // Liability form submission
    document.getElementById('liability-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('liability-name').value;
      const amount = parseFloat(document.getElementById('liability-amount').value);
      const currency = document.getElementById('liability-currency').value;
      const rate = parseFloat(document.getElementById('liability-rate').value) || 0;
      const type = document.getElementById('liability-type').value;
      const description = document.getElementById('liability-description').value || '';
      let monthlyExpense = parseFloat(document.getElementById('liability-monthly-expense').value) || 0;
      let monthlyCur = document.getElementById('liability-monthly-expense-currency').value || 'RUB';
      const monthlyExpenseRub = convertToRub(monthlyExpense, monthlyCur);
      const amountInRub = convertToRub(amount, currency);
      
      if (editingLiability !== null) {
        // Update existing liability
        const liability = getLiabilities().find(l => l.id === editingLiability);
        if (liability) {
          liability.name = name;
          liability.amount = amount;
          liability.currency = currency;
          liability.amountInRub = amountInRub;
          liability.rate = rate;
          liability.type = type;
          liability.description = description;
          liability.monthlyExpense = monthlyExpenseRub;
          liability.monthlyExpenseOriginal = monthlyExpense;
          liability.expenseCurrency = monthlyCur;
        }
        cancelEditLiability();
      } else {
        // Add new liability
        getLiabilities().push({
          id: nextId++,
          name,
          amount,
          currency,
          amountInRub,
          rate,
          type,
          description,
          monthlyExpense: monthlyExpenseRub,
          monthlyExpenseOriginal: monthlyExpense,
          expenseCurrency: monthlyCur
        });
        e.target.reset();
        document.getElementById('liability-currency').innerHTML = getCurrencyOptionsHtml('RUB');
        document.getElementById('liability-monthly-expense-currency').innerHTML = getCurrencyOptionsHtml('RUB');
        updateRubEquivalentDisplay('liability-amount','liability-currency','liability-rub-value-display');
        updateRubEquivalentDisplay('liability-monthly-expense','liability-monthly-expense-currency','liability-expense-rub-value-display');
      }
      
      updateLiabilityList();
      updateTotals();
      autoSaveMonthlyData();
    });

    // Edit functions for Income
    function editIncome(id) {
      const income = getIncomes().find(i => i.id === id);
      if (!income) return;
      
      editingIncome = id;
      document.getElementById('income-amount').value = income.amount;
      document.getElementById('income-currency').innerHTML = getCurrencyOptionsHtml(income.currency);
      document.getElementById('income-category').value = income.category;
      document.getElementById('income-description').value = income.description || '';
      
      updateRubEquivalentDisplay('income-amount','income-currency','income-rub-value-display');
      
      document.getElementById('income-form-title').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –î–æ—Ö–æ–¥';
      document.getElementById('income-submit-btn').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      document.getElementById('income-cancel-btn').style.display = 'inline-flex';
      document.getElementById('income-form').parentElement.classList.add('form-edit-mode');
      
      updateIncomeList();
    }

    function cancelEditIncome() {
      editingIncome = null;
      document.getElementById('income-form').reset();
      document.getElementById('income-currency').innerHTML = getCurrencyOptionsHtml('RUB');
      updateRubEquivalentDisplay('income-amount','income-currency','income-rub-value-display');
      
      document.getElementById('income-form-title').textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –î–æ—Ö–æ–¥';
      document.getElementById('income-submit-btn').textContent = '‚úì –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥';
      document.getElementById('income-cancel-btn').style.display = 'none';
      document.getElementById('income-form').parentElement.classList.remove('form-edit-mode');
      
      updateIncomeList();
    }

    // Edit functions for Expense
    function editExpense(id) {
      const expense = getExpenses().find(e => e.id === id);
      if (!expense) return;
      
      editingExpense = id;
      document.getElementById('expense-amount').value = expense.amount;
      document.getElementById('expense-currency').innerHTML = getCurrencyOptionsHtml(expense.currency);
      document.getElementById('expense-category').value = expense.category;
      document.getElementById('expense-description').value = expense.description || '';
      
      updateRubEquivalentDisplay('expense-amount','expense-currency','expense-rub-value-display');
      
      document.getElementById('expense-form-title').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –†–∞—Å—Ö–æ–¥';
      document.getElementById('expense-submit-btn').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      document.getElementById('expense-cancel-btn').style.display = 'inline-flex';
      document.getElementById('expense-form').parentElement.classList.add('form-edit-mode');
      
      updateExpenseList();
    }

    function cancelEditExpense() {
      editingExpense = null;
      document.getElementById('expense-form').reset();
      document.getElementById('expense-currency').innerHTML = getCurrencyOptionsHtml('RUB');
      updateRubEquivalentDisplay('expense-amount','expense-currency','expense-rub-value-display');
      
      document.getElementById('expense-form-title').textContent = '‚ûñ –î–æ–±–∞–≤–∏—Ç—å –†–∞—Å—Ö–æ–¥';
      document.getElementById('expense-submit-btn').textContent = '‚úì –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥';
      document.getElementById('expense-cancel-btn').style.display = 'none';
      document.getElementById('expense-form').parentElement.classList.remove('form-edit-mode');
      
      updateExpenseList();
    }

    // Edit functions for Asset
    function editAsset(id) {
      const asset = getAssets().find(a => a.id === id);
      if (!asset) return;
      
      editingAsset = id;
      document.getElementById('asset-name').value = asset.name;
      document.getElementById('asset-value').value = asset.value;
      document.getElementById('asset-currency').innerHTML = getCurrencyOptionsHtml(asset.currency);
      document.getElementById('asset-type').value = asset.type;
      document.getElementById('asset-description').value = asset.description || '';
      
      // Handle income type
      if (asset.incomeType === 'percent') {
        toggleAssetIncomeType('percent');
        const yearlyPercent = asset.valueInRub > 0 ? (asset.monthlyIncome * 12 / asset.valueInRub) * 100 : 0;
        document.getElementById('asset-yearly-percent').value = yearlyPercent.toFixed(2);
      } else {
        toggleAssetIncomeType('fixed');
        // Store original income currency or default to RUB
        const incCurrency = asset.incomeCurrency || 'RUB';
        const monthlyIncomeInOriginalCurrency = asset.monthlyIncomeOriginal || (asset.monthlyIncome / (exchangeRates[incCurrency.toLowerCase()]?.rub || 1));
        document.getElementById('asset-monthly-income').value = monthlyIncomeInOriginalCurrency.toFixed(2);
        document.getElementById('asset-monthly-income-currency').innerHTML = getCurrencyOptionsHtml(incCurrency);
      }
      
      updateRubEquivalentDisplay('asset-value','asset-currency','asset-rub-value-display');
      updateRubEquivalentDisplay('asset-monthly-income','asset-monthly-income-currency','asset-income-rub-value-display');
      
      document.getElementById('asset-form-title').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ê–∫—Ç–∏–≤';
      document.getElementById('asset-submit-btn').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      document.getElementById('asset-cancel-btn').style.display = 'inline-flex';
      document.getElementById('asset-form').parentElement.classList.add('form-edit-mode');
      
      updateAssetList();
    }

    function cancelEditAsset() {
      editingAsset = null;
      document.getElementById('asset-form').reset();
      document.getElementById('asset-currency').innerHTML = getCurrencyOptionsHtml('RUB');
      document.getElementById('asset-monthly-income-currency').innerHTML = getCurrencyOptionsHtml('RUB');
      document.getElementById('asset-description').value = '';
      toggleAssetIncomeType('fixed');
      updateRubEquivalentDisplay('asset-value','asset-currency','asset-rub-value-display');
      updateRubEquivalentDisplay('asset-monthly-income','asset-monthly-income-currency','asset-income-rub-value-display');
      
      document.getElementById('asset-form-title').textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –ê–∫—Ç–∏–≤';
      document.getElementById('asset-submit-btn').textContent = '‚úì –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤';
      document.getElementById('asset-cancel-btn').style.display = 'none';
      document.getElementById('asset-form').parentElement.classList.remove('form-edit-mode');
      
      updateAssetList();
    }

    // Edit functions for Liability
    function editLiability(id) {
      const liability = getLiabilities().find(l => l.id === id);
      if (!liability) return;
      
      editingLiability = id;
      document.getElementById('liability-name').value = liability.name;
      document.getElementById('liability-amount').value = liability.amount;
      document.getElementById('liability-currency').innerHTML = getCurrencyOptionsHtml(liability.currency);
      document.getElementById('liability-rate').value = liability.rate || '';
      document.getElementById('liability-type').value = liability.type;
      document.getElementById('liability-description').value = liability.description || '';
      
      const expCur = liability.expenseCurrency || 'RUB';
      const monthlyExpenseOriginal = liability.monthlyExpenseOriginal || (liability.monthlyExpense / (exchangeRates[expCur.toLowerCase()]?.rub || 1));
      document.getElementById('liability-monthly-expense').value = monthlyExpenseOriginal.toFixed(2);
      document.getElementById('liability-monthly-expense-currency').innerHTML = getCurrencyOptionsHtml(expCur);
      
      updateRubEquivalentDisplay('liability-amount','liability-currency','liability-rub-value-display');
      updateRubEquivalentDisplay('liability-monthly-expense','liability-monthly-expense-currency','liability-expense-rub-value-display');
      
      document.getElementById('liability-form-title').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ü–∞—Å—Å–∏–≤';
      document.getElementById('liability-submit-btn').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      document.getElementById('liability-cancel-btn').style.display = 'inline-flex';
      document.getElementById('liability-form').parentElement.classList.add('form-edit-mode');
      
      updateLiabilityList();
    }

    function cancelEditLiability() {
      editingLiability = null;
      document.getElementById('liability-form').reset();
      document.getElementById('liability-currency').innerHTML = getCurrencyOptionsHtml('RUB');
      document.getElementById('liability-monthly-expense-currency').innerHTML = getCurrencyOptionsHtml('RUB');
      document.getElementById('liability-description').value = '';
      updateRubEquivalentDisplay('liability-amount','liability-currency','liability-rub-value-display');
      updateRubEquivalentDisplay('liability-monthly-expense','liability-monthly-expense-currency','liability-expense-rub-value-display');
      
      document.getElementById('liability-form-title').textContent = '‚ûñ –î–æ–±–∞–≤–∏—Ç—å –ü–∞—Å—Å–∏–≤';
      document.getElementById('liability-submit-btn').textContent = '‚úì –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Å—Å–∏–≤';
      document.getElementById('liability-cancel-btn').style.display = 'none';
      document.getElementById('liability-form').parentElement.classList.remove('form-edit-mode');
      
      updateLiabilityList();
    }

    // Edit functions for Recurring Income
    function editRecurringIncome(id) {
      const income = getRecurringIncomes().find(i => i.id === id);
      if (!income) return;
      
      editingRecurringIncome = id;
      document.getElementById('recurring-income-name').value = income.name;
      document.getElementById('recurring-income-amount').value = income.amount;
      document.getElementById('recurring-income-currency').innerHTML = getCurrencyOptionsHtml(income.currency);
      document.getElementById('recurring-income-frequency').value = income.frequency;
      document.getElementById('recurring-income-description').value = income.description || '';
      
      updateRubEquivalentDisplay('recurring-income-amount','recurring-income-currency','recurring-income-rub-value-display');
      
      document.getElementById('recurring-income-form-title').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –¥–æ—Ö–æ–¥';
      document.getElementById('recurring-income-submit-btn').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      document.getElementById('recurring-income-cancel-btn').style.display = 'inline-flex';
      document.getElementById('recurring-income-form').parentElement.classList.add('form-edit-mode');
      
      updateRecurringLists();
    }

    function cancelEditRecurringIncome() {
      editingRecurringIncome = null;
      document.getElementById('recurring-income-form').reset();
      document.getElementById('recurring-income-currency').innerHTML = getCurrencyOptionsHtml('RUB');
      document.getElementById('recurring-income-description').value = '';
      updateRubEquivalentDisplay('recurring-income-amount','recurring-income-currency','recurring-income-rub-value-display');
      
      document.getElementById('recurring-income-form-title').textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –¥–æ—Ö–æ–¥';
      document.getElementById('recurring-income-submit-btn').textContent = '‚úì –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥';
      document.getElementById('recurring-income-cancel-btn').style.display = 'none';
      document.getElementById('recurring-income-form').parentElement.classList.remove('form-edit-mode');
      
      updateRecurringLists();
    }

    // Edit functions for Recurring Expense
    function editRecurringExpense(id) {
      const expense = getRecurringExpenses().find(e => e.id === id);
      if (!expense) return;
      
      editingRecurringExpense = id;
      document.getElementById('recurring-expense-name').value = expense.name;
      document.getElementById('recurring-expense-amount').value = expense.amount;
      document.getElementById('recurring-expense-currency').innerHTML = getCurrencyOptionsHtml(expense.currency);
      document.getElementById('recurring-expense-frequency').value = expense.frequency;
      document.getElementById('recurring-expense-description').value = expense.description || '';
      
      updateRubEquivalentDisplay('recurring-expense-amount','recurring-expense-currency','recurring-expense-rub-value-display');
      
      document.getElementById('recurring-expense-form-title').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Ä–∞—Å—Ö–æ–¥';
      document.getElementById('recurring-expense-submit-btn').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      document.getElementById('recurring-expense-cancel-btn').style.display = 'inline-flex';
      document.getElementById('recurring-expense-form').parentElement.classList.add('form-edit-mode');
      
      updateRecurringLists();
    }

    function cancelEditRecurringExpense() {
      editingRecurringExpense = null;
      document.getElementById('recurring-expense-form').reset();
      document.getElementById('recurring-expense-currency').innerHTML = getCurrencyOptionsHtml('RUB');
      document.getElementById('recurring-expense-description').value = '';
      updateRubEquivalentDisplay('recurring-expense-amount','recurring-expense-currency','recurring-expense-rub-value-display');
      
      document.getElementById('recurring-expense-form-title').textContent = '‚ûñ –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Ä–∞—Å—Ö–æ–¥';
      document.getElementById('recurring-expense-submit-btn').textContent = '‚úì –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥';
      document.getElementById('recurring-expense-cancel-btn').style.display = 'none';
      document.getElementById('recurring-expense-form').parentElement.classList.remove('form-edit-mode');
      
      updateRecurringLists();
    }

    // Delete functions
    function deleteIncome(id) {
      if (editingIncome === id) {
        cancelEditIncome();
      }
      const data = getCurrentMonthData();
      data.incomes = data.incomes.filter(item => item.id !== id);
      updateIncomeList();
      updateTotals();
      autoSaveMonthlyData();
    }

    function deleteExpense(id) {
      if (editingExpense === id) {
        cancelEditExpense();
      }
      const data = getCurrentMonthData();
      data.expenses = data.expenses.filter(item => item.id !== id);
      updateExpenseList();
      updateTotals();
      autoSaveMonthlyData();
    }

    function deleteAsset(id) {
      if (editingAsset === id) {
        cancelEditAsset();
      }
      const data = getCurrentMonthData();
      data.assets = data.assets.filter(item => item.id !== id);
      updateAssetList();
      updateTotals();
      autoSaveMonthlyData();
    }

    function deleteLiability(id) {
      if (editingLiability === id) {
        cancelEditLiability();
      }
      const data = getCurrentMonthData();
      data.liabilities = data.liabilities.filter(item => item.id !== id);
      updateLiabilityList();
      updateTotals();
      autoSaveMonthlyData();
    }

    // Update income list
    function updateIncomeList() {
      const list = document.getElementById('income-list');
      const incomes = getIncomes();
      if (incomes.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –¥–æ—Ö–æ–¥–∞—Ö</p></div>';
        return;
      }
      
      list.innerHTML = incomes.map(item => {
        const symbol = getCurrencySymbol(item.currency);
        const displayAmount = `${formatNumber(item.amount)} ${symbol}`;
        const rubEquiv = item.currency !== 'RUB' ? ` (${formatNumber(item.amountInRub)} ‚ÇΩ)` : '';
        const isEditing = editingIncome === item.id;
        return `
        <div class="entry-item ${isEditing ? 'editing' : ''}">
          <div class="entry-info">
            <div class="entry-amount positive">+${displayAmount}${rubEquiv}</div>
            <div class="entry-category">${item.category}</div>
            <div class="entry-description">${item.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
            ${isEditing ? '<div style="color: var(--color-primary); font-weight: var(--font-weight-semibold); margin-top: var(--space-4); font-size: var(--font-size-xs);">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è...</div>' : ''}
          </div>
          <div class="entry-actions">
            <button class="btn btn-edit" onclick="editIncome(${item.id})">–ò–∑–º–µ–Ω–∏—Ç—å</button>
            <button class="btn btn-delete" onclick="deleteIncome(${item.id})">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      `}).join('');
    }

    // Update expense list
    function updateExpenseList() {
      const list = document.getElementById('expense-list');
      const expenses = getExpenses();
      if (expenses.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö</p></div>';
        return;
      }
      
      list.innerHTML = expenses.map(item => {
        const symbol = getCurrencySymbol(item.currency);
        const displayAmount = `${formatNumber(item.amount)} ${symbol}`;
        const rubEquiv = item.currency !== 'RUB' ? ` (${formatNumber(item.amountInRub)} ‚ÇΩ)` : '';
        const isEditing = editingExpense === item.id;
        return `
        <div class="entry-item ${isEditing ? 'editing' : ''}">
          <div class="entry-info">
            <div class="entry-amount negative">-${displayAmount}${rubEquiv}</div>
            <div class="entry-category">${item.category}</div>
            <div class="entry-description">${item.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
            ${isEditing ? '<div style="color: var(--color-primary); font-weight: var(--font-weight-semibold); margin-top: var(--space-4); font-size: var(--font-size-xs);">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è...</div>' : ''}
          </div>
          <div class="entry-actions">
            <button class="btn btn-edit" onclick="editExpense(${item.id})">–ò–∑–º–µ–Ω–∏—Ç—å</button>
            <button class="btn btn-delete" onclick="deleteExpense(${item.id})">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      `}).join('');
    }

    // Escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // Update asset list
    function updateAssetList() {
      const list = document.getElementById('asset-list');
      const assets = getAssets();
      if (assets.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ–± –∞–∫—Ç–∏–≤–∞—Ö</p></div>';
        return;
      }
      list.innerHTML = assets.map(item => {
        const symbol = getCurrencySymbol(item.currency);
        const displayAmount = `${formatNumber(item.value)} ${symbol}`;
        const rubEquiv = item.currency !== 'RUB' ? ` (${formatNumber(item.valueInRub)} ‚ÇΩ)` : '';
        const isEditing = editingAsset === item.id;
        return `
        <div class="entry-item ${isEditing ? 'editing' : ''}">
          <div class="entry-info">
            <div class="entry-amount positive">${displayAmount}${rubEquiv}</div>
            <div class="entry-category">${item.type}</div>
            <div class="entry-description"><b>${item.name}</b>${item.description ? ` ‚Äî ${escapeHtml(item.description)}` : ''}</div>
            ${item.monthlyIncome > 0 ? `<div class="entry-description" style="color: var(--color-success); font-weight: var(--font-weight-semibold);">üìà –î–æ—Ö–æ–¥: +${formatNumber(item.monthlyIncome)} ‚ÇΩ/–º–µ—Å.</div>` : ''}
            ${isEditing ? '<div style="color: var(--color-primary); font-weight: var(--font-weight-semibold); margin-top: var(--space-4); font-size: var(--font-size-xs);">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è...</div>' : ''}
          </div>
          <div class="entry-actions">
            <button class="btn btn-edit" onclick="editAsset(${item.id})">–ò–∑–º–µ–Ω–∏—Ç—å</button>
            <button class="btn btn-delete" onclick="deleteAsset(${item.id})">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      `}).join('');
    }

    // Update liability list
    function updateLiabilityList() {
      const list = document.getElementById('liability-list');
      const liabilities = getLiabilities();
      if (liabilities.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –ø–∞—Å—Å–∏–≤–∞—Ö</p></div>';
        return;
      }
      list.innerHTML = liabilities.map(item => {
        const symbol = getCurrencySymbol(item.currency);
        const displayAmount = `${formatNumber(item.amount)} ${symbol}`;
        const rubEquiv = item.currency !== 'RUB' ? ` (${formatNumber(item.amountInRub)} ‚ÇΩ)` : '';
        const isEditing = editingLiability === item.id;
        return `
        <div class="entry-item ${isEditing ? 'editing' : ''}">
          <div class="entry-info">
            <div class="entry-amount negative">${displayAmount}${rubEquiv}</div>
            <div class="entry-category">${item.type} ${item.rate > 0 ? `(${item.rate}%)` : ''}</div>
            <div class="entry-description"><b>${item.name}</b>${item.description ? ` ‚Äî ${escapeHtml(item.description)}` : ''}</div>
            ${item.monthlyExpense > 0 ? `<div class="entry-description" style="color: var(--color-error); font-weight: var(--font-weight-semibold);">üìâ –†–∞—Å—Ö–æ–¥: -${formatNumber(item.monthlyExpense)} ‚ÇΩ/–º–µ—Å.</div>` : ''}
            ${isEditing ? '<div style="color: var(--color-primary); font-weight: var(--font-weight-semibold); margin-top: var(--space-4); font-size: var(--font-size-xs);">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è...</div>' : ''}
          </div>
          <div class="entry-actions">
            <button class="btn btn-edit" onclick="editLiability(${item.id})">–ò–∑–º–µ–Ω–∏—Ç—å</button>
            <button class="btn btn-delete" onclick="deleteLiability(${item.id})">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      `}).join('');
    }

    // Calculate totals
    function getTotalIncome() {
      return getIncomes().reduce((sum, item) => sum + item.amountInRub, 0);
    }

    function getTotalExpenses() {
      return getExpenses().reduce((sum, item) => sum + item.amountInRub, 0);
    }

    function getTotalRecurringIncome() {
      return getRecurringIncomes().reduce((sum, x) => sum + frequencyToMonthly(x.amountInRub, x.frequency), 0);
    }
    function getTotalRecurringExpense() {
      return getRecurringExpenses().reduce((sum, x) => sum + frequencyToMonthly(x.amountInRub, x.frequency), 0);
    }
    function getMonthlyAssetIncome() {
      return getAssets().reduce((sum, item) => sum + (item.monthlyIncome || 0), 0);
    }
    function getMonthlyLiabilityExpense() {
      return getLiabilities().reduce((sum, item) => sum + (item.monthlyExpense || 0), 0);
    }

    function getTotalAssets() {
      return getAssets().reduce((sum, item) => sum + item.valueInRub, 0);
    }

    function getTotalLiabilities() {
      return getLiabilities().reduce((sum, item) => sum + item.amountInRub, 0);
    }

    // Recurring income form submission
    document.getElementById('recurring-income-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('recurring-income-name').value;
      const amount = parseFloat(document.getElementById('recurring-income-amount').value);
      const currency = document.getElementById('recurring-income-currency').value;
      const frequency = document.getElementById('recurring-income-frequency').value;
      const description = document.getElementById('recurring-income-description').value || '';
      const amountInRub = convertToRub(amount, currency);
      
      if (editingRecurringIncome !== null) {
        // Update existing recurring income
        const income = getRecurringIncomes().find(i => i.id === editingRecurringIncome);
        if (income) {
          income.name = name;
          income.amount = amount;
          income.currency = currency;
          income.amountInRub = amountInRub;
          income.frequency = frequency;
          income.description = description;
        }
        cancelEditRecurringIncome();
      } else {
        // Add new recurring income
        getRecurringIncomes().push({
          id: nextId++,
          name,
          amount,
          currency,
          amountInRub,
          frequency,
          description
        });
        e.target.reset();
        document.getElementById('recurring-income-currency').innerHTML = getCurrencyOptionsHtml('RUB');
        updateRubEquivalentDisplay('recurring-income-amount','recurring-income-currency','recurring-income-rub-value-display');
      }
      
      updateRecurringLists();
      updateTotals();
      autoSaveMonthlyData();
    });
    // Recurring expense form submission
    document.getElementById('recurring-expense-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('recurring-expense-name').value;
      const amount = parseFloat(document.getElementById('recurring-expense-amount').value);
      const currency = document.getElementById('recurring-expense-currency').value;
      const frequency = document.getElementById('recurring-expense-frequency').value;
      const description = document.getElementById('recurring-expense-description').value || '';
      const amountInRub = convertToRub(amount, currency);
      
      if (editingRecurringExpense !== null) {
        // Update existing recurring expense
        const expense = getRecurringExpenses().find(e => e.id === editingRecurringExpense);
        if (expense) {
          expense.name = name;
          expense.amount = amount;
          expense.currency = currency;
          expense.amountInRub = amountInRub;
          expense.frequency = frequency;
          expense.description = description;
        }
        cancelEditRecurringExpense();
      } else {
        // Add new recurring expense
        getRecurringExpenses().push({
          id: nextId++,
          name,
          amount,
          currency,
          amountInRub,
          frequency,
          description
        });
        e.target.reset();
        document.getElementById('recurring-expense-currency').innerHTML = getCurrencyOptionsHtml('RUB');
        updateRubEquivalentDisplay('recurring-expense-amount','recurring-expense-currency','recurring-expense-rub-value-display');
      }
      
      updateRecurringLists();
      updateTotals();
    });

    function deleteRecurringIncome(id) {
      if (editingRecurringIncome === id) {
        cancelEditRecurringIncome();
      }
      const data = getCurrentMonthData();
      data.recurringIncomes = data.recurringIncomes.filter(item => item.id !== id);
      updateRecurringLists();
      updateTotals();
      autoSaveMonthlyData();
    }
    
    function deleteRecurringExpense(id) {
      if (editingRecurringExpense === id) {
        cancelEditRecurringExpense();
      }
      const data = getCurrentMonthData();
      data.recurringExpenses = data.recurringExpenses.filter(item => item.id !== id);
      updateRecurringLists();
      updateTotals();
      autoSaveMonthlyData();
    }

    function updateRecurringLists() {
      // Recurring Incomes
      const list = document.getElementById('recurring-income-list');
      const recurringIncomes = getRecurringIncomes();
      if (recurringIncomes.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>–ù–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –¥–æ—Ö–æ–¥–æ–≤</p></div>';
      } else {
        list.innerHTML = recurringIncomes.map(item => {
          const symbol = getCurrencySymbol(item.currency);
          const displayAmount = `${formatNumber(item.amount)} ${symbol}`;
          const rubEquiv = item.currency !== 'RUB' ? ` (${formatNumber(item.amountInRub)} ‚ÇΩ)` : '';
          const perMonth = frequencyToMonthly(item.amountInRub, item.frequency);
          let freqDesc = item.frequency;
          const isEditing = editingRecurringIncome === item.id;
          return `<div class="entry-item ${isEditing ? 'editing' : ''}">
            <div class="entry-info">
              <div class="entry-amount positive">+${displayAmount}${rubEquiv}</div>
              <div class="entry-category">${freqDesc}</div>
              <div class="entry-description"><b>${item.name}</b>${item.description ? ` ‚Äî ${escapeHtml(item.description)}` : ''}</div>
              <div class="entry-description">–í –º–µ—Å—è—Ü: <b>${formatNumber(perMonth)} ‚ÇΩ</b></div>
              ${isEditing ? '<div style="color: var(--color-primary); font-weight: var(--font-weight-semibold); margin-top: var(--space-4); font-size: var(--font-size-xs);">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è...</div>' : ''}
            </div>
            <div class="entry-actions">
              <button class="btn btn-edit" onclick="editRecurringIncome(${item.id})">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              <button class="btn btn-delete" onclick="deleteRecurringIncome(${item.id})">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>`;
        }).join('');
      }
      // Recurring Expenses
      const exList = document.getElementById('recurring-expense-list');
      const recurringExpenses = getRecurringExpenses();
      if (recurringExpenses.length === 0) {
        exList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>–ù–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤</p></div>';
      } else {
        exList.innerHTML = recurringExpenses.map(item => {
          const symbol = getCurrencySymbol(item.currency);
          const displayAmount = `${formatNumber(item.amount)} ${symbol}`;
          const rubEquiv = item.currency !== 'RUB' ? ` (${formatNumber(item.amountInRub)} ‚ÇΩ)` : '';
          const perMonth = frequencyToMonthly(item.amountInRub, item.frequency);
          let freqDesc = item.frequency;
          const isEditing = editingRecurringExpense === item.id;
          return `<div class="entry-item ${isEditing ? 'editing' : ''}">
            <div class="entry-info">
              <div class="entry-amount negative">-${displayAmount}${rubEquiv}</div>
              <div class="entry-category">${freqDesc}</div>
              <div class="entry-description"><b>${item.name}</b>${item.description ? ` ‚Äî ${escapeHtml(item.description)}` : ''}</div>
              <div class="entry-description">–í –º–µ—Å—è—Ü: <b>${formatNumber(perMonth)} ‚ÇΩ</b></div>
              ${isEditing ? '<div style="color: var(--color-primary); font-weight: var(--font-weight-semibold); margin-top: var(--space-4); font-size: var(--font-size-xs);">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è...</div>' : ''}
            </div>
            <div class="entry-actions">
              <button class="btn btn-edit" onclick="editRecurringExpense(${item.id})">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              <button class="btn btn-delete" onclick="deleteRecurringExpense(${item.id})">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>`;
        }).join('');
      }
      // Totals
      document.getElementById('total-recurring-income').textContent = `${formatNumber(getTotalRecurringIncome())} ‚ÇΩ`;
      document.getElementById('total-recurring-expense').textContent = `${formatNumber(getTotalRecurringExpense())} ‚ÇΩ`;
    }

    // Update all totals
    function updateTotals() {
      const totalIncome = getTotalIncome() + getTotalRecurringIncome() + getMonthlyAssetIncome();
      const totalExpenses = getTotalExpenses() + getTotalRecurringExpense() + getMonthlyLiabilityExpense();
      const totalAssets = getTotalAssets();
      const totalLiabilities = getTotalLiabilities();
      const difference = getTotalIncome() - getTotalExpenses(); // one-time
      const netWorth = totalAssets - totalLiabilities;
      const assetMonthlyIncome = getMonthlyAssetIncome();
      const liabilityMonthlyExpense = getMonthlyLiabilityExpense();
      const recurringMonthlyIncome = getTotalRecurringIncome();
      const recurringMonthlyExpense = getTotalRecurringExpense();

      // For views, keep one-time and monthly distinction
      document.getElementById('total-income').textContent = `${formatNumber(getTotalIncome())} ‚ÇΩ`;
      document.getElementById('total-expenses').textContent = `${formatNumber(getTotalExpenses())} ‚ÇΩ`;
      
      const diffElement = document.getElementById('income-expense-diff');
      diffElement.textContent = `${formatNumber(difference)} ‚ÇΩ`;
      diffElement.className = difference >= 0 ? 'positive' : 'negative';
      
      // Assets/Liabilities view
      document.getElementById('total-assets').textContent = `${formatNumber(totalAssets)} ‚ÇΩ`;
      document.getElementById('total-liabilities').textContent = `${formatNumber(totalLiabilities)} ‚ÇΩ`;
      const netWorthElement = document.getElementById('net-worth');
      netWorthElement.textContent = `${formatNumber(netWorth)} ‚ÇΩ`;
      netWorthElement.className = netWorth >= 0 ? 'positive' : 'negative';

      // Update recurring payment tab totals too
      document.getElementById('total-recurring-income').textContent = `${formatNumber(recurringMonthlyIncome)} ‚ÇΩ`;
      document.getElementById('total-recurring-expense').textContent = `${formatNumber(recurringMonthlyExpense)} ‚ÇΩ`;

      // Update cashflow view
      updateCashflowView();

      // Update summary view (with full breakdown)
      updateSummaryView();
    }

    // Update cashflow view
    function updateCashflowView() {
      // Monthly cashflow all-in
      const cfIncome = getTotalIncome() + getTotalRecurringIncome() + getMonthlyAssetIncome();
      const cfExpense = getTotalExpenses() + getTotalRecurringExpense() + getMonthlyLiabilityExpense();
      const cashflow = cfIncome - cfExpense;
      const maxValue = Math.max(cfIncome, cfExpense, 1);
      // Update bars
      const incomeBar = document.getElementById('income-bar');
      const expenseBar = document.getElementById('expense-bar');
      const incomeHeight = (cfIncome / maxValue) * 250;
      const expenseHeight = (cfExpense / maxValue) * 250;
      incomeBar.style.height = `${incomeHeight}px`;
      expenseBar.style.height = `${expenseHeight}px`;
      document.getElementById('income-bar-value').textContent = `${formatNumber(cfIncome)} ‚ÇΩ`;
      document.getElementById('expense-bar-value').textContent = `${formatNumber(cfExpense)} ‚ÇΩ`;
      // Update statement
      document.getElementById('cf-income').textContent = `${formatNumber(cfIncome)} ‚ÇΩ`;
      document.getElementById('cf-expenses').textContent = `${formatNumber(cfExpense)} ‚ÇΩ`;
      const cfResult = document.getElementById('cf-result');
      cfResult.textContent = `${formatNumber(cashflow)} ‚ÇΩ`;
      cfResult.className = cashflow >= 0 ? 'positive' : 'negative';
      // Update analysis
      document.getElementById('net-income-value').textContent = `${formatNumber(cashflow)} ‚ÇΩ`;
      const expensePercent = cfIncome > 0 ? (cfExpense / cfIncome * 100) : 0;
      document.getElementById('expense-percentage').textContent = `${expensePercent.toFixed(1)}%`;
      const savingsRate = cfIncome > 0 ? ((cfIncome - cfExpense) / cfIncome * 100) : 0;
      const savingsElement = document.getElementById('savings-rate');
      savingsElement.textContent = `${savingsRate.toFixed(1)}%`;
      savingsElement.className = savingsRate >= 0 ? 'positive' : 'negative';
    }



    // Update summary view
    function updateSummaryView() {
      const oneTimeIncome = getTotalIncome();
      const oneTimeExpense = getTotalExpenses();
      const assetMonthlyIncome = getMonthlyAssetIncome();
      const recurringMonthlyIncome = getTotalRecurringIncome();
      const recurringMonthlyExpense = getTotalRecurringExpense();
      const liabilityMonthlyExpense = getMonthlyLiabilityExpense();
      const totalAssets = getTotalAssets();
      const totalLiabilities = getTotalLiabilities();
      const netWorth = totalAssets - totalLiabilities;
      const totalIncomeAll = oneTimeIncome + recurringMonthlyIncome + assetMonthlyIncome;
      const totalExpenseAll = oneTimeExpense + recurringMonthlyExpense + liabilityMonthlyExpense;
      const cashflow = totalIncomeAll - totalExpenseAll;
      // Update summary cards
      const netWorthElement = document.getElementById('summary-net-worth');
      netWorthElement.textContent = `${formatNumber(netWorth)} ‚ÇΩ`;
      netWorthElement.className = `summary-value ${netWorth >= 0 ? 'positive' : 'negative'}`;
      document.getElementById('summary-income').textContent = `${formatNumber(totalIncomeAll)} ‚ÇΩ`;
      document.getElementById('summary-expenses').textContent = `${formatNumber(totalExpenseAll)} ‚ÇΩ`;
      const cashflowElement = document.getElementById('summary-cashflow');
      cashflowElement.textContent = `${formatNumber(cashflow)} ‚ÇΩ`;
      cashflowElement.className = `summary-value ${cashflow >= 0 ? 'positive' : 'negative'}`;
      // Update simple balance panels
      document.getElementById('summary-assets-value').textContent = `${formatNumber(totalAssets)} ‚ÇΩ`;
      document.getElementById('summary-liabilities-value').textContent = `${formatNumber(totalLiabilities)} ‚ÇΩ`;
      const netWorthDiffElement = document.getElementById('summary-net-worth-diff');
      netWorthDiffElement.textContent = `${formatNumber(netWorth)} ‚ÇΩ`;
      netWorthDiffElement.style.color = netWorth >= 0 ? 'var(--color-primary)' : 'var(--color-error)';
      
      document.getElementById('summary-asset-income').textContent = `+${formatNumber(assetMonthlyIncome)} ‚ÇΩ`;
      document.getElementById('summary-liability-expense').textContent = `-${formatNumber(liabilityMonthlyExpense)} ‚ÇΩ`;
      const monthlyDiffElement = document.getElementById('summary-monthly-diff');
      const monthlyDiff = assetMonthlyIncome - liabilityMonthlyExpense;
      monthlyDiffElement.textContent = `${formatNumber(monthlyDiff)} ‚ÇΩ/–º–µ—Å.`;
      monthlyDiffElement.style.color = monthlyDiff >= 0 ? 'var(--color-primary)' : 'var(--color-error)';
      
      // No breakdown or health indicator in Summary tab - moved to Reports
    }

    // Initialize currency dropdowns
    function initializeCurrencyDropdowns() {
      document.getElementById('income-currency').innerHTML = getCurrencyOptionsHtml('RUB');
      document.getElementById('expense-currency').innerHTML = getCurrencyOptionsHtml('RUB');
      document.getElementById('asset-currency').innerHTML = getCurrencyOptionsHtml('RUB');
      document.getElementById('liability-currency').innerHTML = getCurrencyOptionsHtml('RUB');
      document.getElementById('asset-monthly-income-currency').innerHTML = getCurrencyOptionsHtml('RUB');
      document.getElementById('liability-monthly-expense-currency').innerHTML = getCurrencyOptionsHtml('RUB');
      document.getElementById('recurring-income-currency').innerHTML = getCurrencyOptionsHtml('RUB');
      document.getElementById('recurring-expense-currency').innerHTML = getCurrencyOptionsHtml('RUB');
    }

    // After DOM content, set rub-value display fields
    function initializeRubDisplays() {
      document.getElementById('income-rub-value-display').textContent = '‚ÇΩ';
      document.getElementById('expense-rub-value-display').textContent = '‚ÇΩ';
      document.getElementById('asset-rub-value-display').textContent = '‚ÇΩ';
      document.getElementById('asset-income-rub-value-display').textContent = '‚ÇΩ';
      document.getElementById('liability-rub-value-display').textContent = '‚ÇΩ';
      document.getElementById('liability-expense-rub-value-display').textContent = '‚ÇΩ';
      document.getElementById('recurring-income-rub-value-display').textContent = '‚ÇΩ';
      document.getElementById('recurring-expense-rub-value-display').textContent = '‚ÇΩ';
    }

    // Initialize app
    async function initializeApp() {
      // Initialize IndexedDB first
      await initIndexedDB();
      
      // Restore all saved data
      await restoreDataFromIndexedDB();
      
      initializeCurrencyDropdowns();
      initializeRubDisplays();
      initRubValueInputs();
      await fetchExchangeRates();
      updateMonthDisplay();
      updateIncomeList();
      updateExpenseList();
      updateAssetList();
      updateLiabilityList();
      updateRecurringLists();
      updateTotals();
      updateSummaryView();
      
      // Update storage status
      const statusEl = document.getElementById('storage-status');
      if (dbAvailable) {
        statusEl.textContent = 'üíæ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ';
        statusEl.style.color = 'var(--color-success)';
      } else {
        statusEl.textContent = '‚ö†Ô∏è –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
        statusEl.style.color = 'var(--color-warning)';
      }
      
      // Auto-refresh rates every 5 minutes (300000 ms)
      setInterval(fetchExchangeRates, 300000);
      // Also update rub values when rates change
      // Override updateAllConversions to refresh live input displays
      const origUpdateAllConversions = updateAllConversions;
      window.updateAllConversions = function() {
        origUpdateAllConversions();
        updateLiveRubDisplays();
      };
    }

    // Update all visible RUB equivalent fields on rate update
    function updateLiveRubDisplays() {
      updateRubEquivalentDisplay('income-amount','income-currency','income-rub-value-display');
      updateRubEquivalentDisplay('expense-amount','expense-currency','expense-rub-value-display');
      updateRubEquivalentDisplay('asset-value','asset-currency','asset-rub-value-display');
      updateRubEquivalentDisplay('asset-monthly-income','asset-monthly-income-currency','asset-income-rub-value-display');
      updateRubEquivalentDisplay('liability-amount','liability-currency','liability-rub-value-display');
      updateRubEquivalentDisplay('liability-monthly-expense','liability-monthly-expense-currency','liability-expense-rub-value-display');
      updateRubEquivalentDisplay('recurring-income-amount','recurring-income-currency','recurring-income-rub-value-display');
      updateRubEquivalentDisplay('recurring-expense-amount','recurring-expense-currency','recurring-expense-rub-value-display');
    }

    // Start the app
    initializeApp();

    // === REPORTS LOGIC ===
    let reportYear = new Date().getFullYear();
    let reportViewType = 'monthly'; // 'monthly' or 'yearly'
    
    function switchReportType(type) {
      reportViewType = type;
      if (type === 'monthly') {
        document.getElementById('monthly-report-btn').style.background = 'var(--color-primary)';
        document.getElementById('monthly-report-btn').style.color = 'var(--color-btn-primary-text)';
        document.getElementById('yearly-report-btn').style.background = 'var(--color-secondary)';
        document.getElementById('yearly-report-btn').style.color = 'var(--color-text)';
        document.getElementById('monthly-report-container').style.display = 'block';
        document.getElementById('yearly-report-container').style.display = 'none';
        renderMonthlyReport();
      } else {
        document.getElementById('yearly-report-btn').style.background = 'var(--color-primary)';
        document.getElementById('yearly-report-btn').style.color = 'var(--color-btn-primary-text)';
        document.getElementById('monthly-report-btn').style.background = 'var(--color-secondary)';
        document.getElementById('monthly-report-btn').style.color = 'var(--color-text)';
        document.getElementById('monthly-report-container').style.display = 'none';
        document.getElementById('yearly-report-container').style.display = 'block';
        renderYearOverview();
      }
    }
    
    function changeReportYear(offset) {
      reportYear += offset;
      renderYearOverview();
    }
    
    function renderMonthlyReport() {
      const monthNames = getMonthNames();
      const monthName = monthNames[currentMonth];
      const year = currentYear;
      
      // Get data for current month
      const data = getCurrentMonthData();
      const oneTimeIncome = data.incomes.reduce((sum, item) => sum + item.amountInRub, 0);
      const oneTimeExpense = data.expenses.reduce((sum, item) => sum + item.amountInRub, 0);
      const assetMonthlyIncome = data.assets.reduce((sum, item) => sum + (item.monthlyIncome || 0), 0);
      const recurringMonthlyIncome = data.recurringIncomes.reduce((sum, x) => sum + frequencyToMonthly(x.amountInRub, x.frequency), 0);
      const recurringMonthlyExpense = data.recurringExpenses.reduce((sum, x) => sum + frequencyToMonthly(x.amountInRub, x.frequency), 0);
      const liabilityMonthlyExpense = data.liabilities.reduce((sum, item) => sum + (item.monthlyExpense || 0), 0);
      
      const totalIncome = oneTimeIncome + recurringMonthlyIncome + assetMonthlyIncome;
      const totalExpense = oneTimeExpense + recurringMonthlyExpense + liabilityMonthlyExpense;
      const cashflow = totalIncome - totalExpense;
      
      const totalAssets = data.assets.reduce((sum, item) => sum + item.valueInRub, 0);
      const totalLiabilities = data.liabilities.reduce((sum, item) => sum + item.amountInRub, 0);
      const netWorth = totalAssets - totalLiabilities;
      
      let html = `
        <div style="text-align: center; border-bottom: 2px solid var(--color-border); padding-bottom: var(--space-16); margin-bottom: var(--space-24);">
          <h2 style="font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); margin: 0 0 var(--space-8) 0;">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç –∑–∞ ${monthName} ${year}</h2>
          <div style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">–î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è: ${new Date().toLocaleDateString('ru-RU')}</div>
        </div>
        
        <!-- Section 1: –î–æ—Ö–æ–¥—ã -->
        <div style="background: var(--color-bg-3); border: 1px solid var(--color-card-border); border-radius: var(--radius-lg); padding: var(--space-20); margin-bottom: var(--space-16);">
          <h3 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin: 0 0 var(--space-16) 0; color: var(--color-success);">üìà –î–æ—Ö–æ–¥—ã (Income Statement)</h3>
          <table style="width: 100%; border-collapse: collapse;">
            
            <tr style="border-bottom: 1px solid var(--color-card-border);">
              <td style="padding: var(--space-10) 0; font-size: var(--font-size-md);">–î–æ—Ö–æ–¥—ã</td>
              <td style="padding: var(--space-10) 0; text-align: right; font-weight: var(--font-weight-semibold);">${formatNumber(oneTimeIncome)} ‚ÇΩ</td>
            </tr>
            <tr style="border-bottom: 1px solid var(--color-card-border);">
              <td style="padding: var(--space-10) 0; font-size: var(--font-size-md);">–î–æ—Ö–æ–¥ –æ—Ç –∞–∫—Ç–∏–≤–æ–≤</td>
              <td style="padding: var(--space-10) 0; text-align: right; font-weight: var(--font-weight-semibold);">${formatNumber(assetMonthlyIncome)} ‚ÇΩ</td>
            </tr>
            <tr style="border-top: 2px solid var(--color-success);">
              <td style="padding: var(--space-12) 0; font-size: var(--font-size-lg); font-weight: var(--font-weight-bold);">–ò–¢–û–ì–û –î–û–•–û–î–û–í</td>
              <td style="padding: var(--space-12) 0; text-align: right; font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success);">${formatNumber(totalIncome)} ‚ÇΩ</td>
            </tr>
          </table>
        </div>
        
        <!-- Section 2: –†–∞—Å—Ö–æ–¥—ã -->
        <div style="background: var(--color-bg-4); border: 1px solid var(--color-card-border); border-radius: var(--radius-lg); padding: var(--space-20); margin-bottom: var(--space-16);">
          <h3 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin: 0 0 var(--space-16) 0; color: var(--color-error);">üìâ –†–∞—Å—Ö–æ–¥—ã (Expense Statement)</h3>
          <table style="width: 100%; border-collapse: collapse;">
            
            <tr style="border-bottom: 1px solid var(--color-card-border);">
              <td style="padding: var(--space-10) 0; font-size: var(--font-size-md);">–†–∞—Å—Ö–æ–¥—ã</td>
              <td style="padding: var(--space-10) 0; text-align: right; font-weight: var(--font-weight-semibold);">${formatNumber(oneTimeExpense)} ‚ÇΩ</td>
            </tr>
            <tr style="border-bottom: 1px solid var(--color-card-border);">
              <td style="padding: var(--space-10) 0; font-size: var(--font-size-md);">–†–∞—Å—Ö–æ–¥—ã –Ω–∞ –ø–∞—Å—Å–∏–≤—ã</td>
              <td style="padding: var(--space-10) 0; text-align: right; font-weight: var(--font-weight-semibold);">${formatNumber(liabilityMonthlyExpense)} ‚ÇΩ</td>
            </tr>
            <tr style="border-top: 2px solid var(--color-error);">
              <td style="padding: var(--space-12) 0; font-size: var(--font-size-lg); font-weight: var(--font-weight-bold);">–ò–¢–û–ì–û –†–ê–°–•–û–î–û–í</td>
              <td style="padding: var(--space-12) 0; text-align: right; font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-error);">${formatNumber(totalExpense)} ‚ÇΩ</td>
            </tr>
          </table>
        </div>
        
        <!-- Section 3: –ö–µ—à—Ñ–ª–æ—É -->
        <div style="background: var(--color-bg-1); border: 2px solid var(--color-primary); border-radius: var(--radius-lg); padding: var(--space-20); margin-bottom: var(--space-16);">
          <h3 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin: 0 0 var(--space-16) 0; color: var(--color-primary);">üí∞ –ö–µ—à—Ñ–ª–æ—É (Cashflow)</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <tr style="border-bottom: 1px solid var(--color-card-border);">
              <td style="padding: var(--space-10) 0; font-size: var(--font-size-md);">–ò—Ç–æ–≥–æ –¥–æ—Ö–æ–¥–æ–≤</td>
              <td style="padding: var(--space-10) 0; text-align: right; font-weight: var(--font-weight-semibold); color: var(--color-success);">${formatNumber(totalIncome)} ‚ÇΩ</td>
            </tr>
            <tr style="border-bottom: 1px solid var(--color-card-border);">
              <td style="padding: var(--space-10) 0; font-size: var(--font-size-md);">–ò—Ç–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤</td>
              <td style="padding: var(--space-10) 0; text-align: right; font-weight: var(--font-weight-semibold); color: var(--color-error);">${formatNumber(totalExpense)} ‚ÇΩ</td>
            </tr>
            <tr style="border-top: 2px solid var(--color-primary);">
              <td style="padding: var(--space-12) 0; font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold);">–ö–ï–®–§–õ–û–£</td>
              <td style="padding: var(--space-12) 0; text-align: right; font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: ${cashflow >= 0 ? 'var(--color-success)' : 'var(--color-error)'};">${ cashflow >= 0 ? '+' : ''}${formatNumber(cashflow)} ‚ÇΩ</td>
            </tr>
          </table>
        </div>
        
        <!-- Section 4: –ë–∞–ª–∞–Ω—Å -->
        <div style="background: var(--color-bg-5); border: 1px solid var(--color-card-border); border-radius: var(--radius-lg); padding: var(--space-20); margin-bottom: var(--space-24);">
          <h3 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin: 0 0 var(--space-16) 0;">‚öñÔ∏è –ë–∞–ª–∞–Ω—Å –∞–∫—Ç–∏–≤–æ–≤ –∏ –ø–∞—Å—Å–∏–≤–æ–≤</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <tr style="border-bottom: 1px solid var(--color-card-border);">
              <td style="padding: var(--space-10) 0; font-size: var(--font-size-md);">–ê–∫—Ç–∏–≤—ã</td>
              <td style="padding: var(--space-10) 0; text-align: right; font-weight: var(--font-weight-semibold); color: var(--color-success);">${formatNumber(totalAssets)} ‚ÇΩ</td>
            </tr>
            <tr style="border-bottom: 1px solid var(--color-card-border);">
              <td style="padding: var(--space-10) 0; font-size: var(--font-size-md);">–ü–∞—Å—Å–∏–≤—ã</td>
              <td style="padding: var(--space-10) 0; text-align: right; font-weight: var(--font-weight-semibold); color: var(--color-error);">${formatNumber(totalLiabilities)} ‚ÇΩ</td>
            </tr>
            <tr style="border-top: 2px solid var(--color-border);">
              <td style="padding: var(--space-12) 0; font-size: var(--font-size-lg); font-weight: var(--font-weight-bold);">–ß–∏—Å—Ç–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ (Net Worth)</td>
              <td style="padding: var(--space-12) 0; text-align: right; font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: ${netWorth >= 0 ? 'var(--color-success)' : 'var(--color-error)'};">${formatNumber(netWorth)} ‚ÇΩ</td>
            </tr>
          </table>
        </div>
        
        <!-- Section 5: –î–∏–∞–≥—Ä–∞–º–º–∞ -->
        <div style="background: var(--color-surface); border: 1px solid var(--color-card-border); border-radius: var(--radius-lg); padding: var(--space-20); margin-bottom: var(--space-24);">
          <h3 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin: 0 0 var(--space-16) 0;">üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</h3>
          <canvas id="monthly-report-chart" style="width:100%;height:300px;max-height:300px;"></canvas>
        </div>
        

      `;
      
      document.getElementById('monthly-report-content').innerHTML = html;
      
      // Render chart
      setTimeout(() => {
        if (window.Chart) {
          const ctx = document.getElementById('monthly-report-chart').getContext('2d');
          if (window.__monthlyReportChart) window.__monthlyReportChart.destroy();
          window.__monthlyReportChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: ['–î–æ—Ö–æ–¥—ã', '–î–æ—Ö–æ–¥ –æ—Ç –∞–∫—Ç–∏–≤–æ–≤',  '–†–∞—Å—Ö–æ–¥—ã', '–†–∞—Å—Ö–æ–¥—ã –Ω–∞ –ø–∞—Å—Å–∏–≤—ã'],
              datasets: [{
                label: '–§–∏–Ω–∞–Ω—Å—ã',
                data: [ oneTimeIncome, assetMonthlyIncome,  oneTimeExpense, liabilityMonthlyExpense],
                backgroundColor: ['#1FB8CD', '#FFC185', '#B4413C', '#ECEBD5', '#5D878F', '#DB4545']
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: true, position: 'bottom' },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return context.label + ': ' + formatNumber(context.parsed) + ' ‚ÇΩ';
                    }
                  }
                }
              }
            }
          });
        }
      }, 100);
    }
    
    function getMonthNames() {
      return ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
    }
    
    function getMonthSummary(year, month) {
      if (!monthlyData[year] || !monthlyData[year][month]) {
        return { totalIncome: 0, totalExpense: 0, cashflow: 0, hasData: false };
      }
      const data = monthlyData[year][month];
      const oneTimeIncome = data.incomes.reduce((sum, item) => sum + item.amountInRub, 0);
      const oneTimeExpense = data.expenses.reduce((sum, item) => sum + item.amountInRub, 0);
      const assetMonthlyIncome = data.assets.reduce((sum, item) => sum + (item.monthlyIncome || 0), 0);
      const recurringMonthlyIncome = data.recurringIncomes.reduce((sum, x) => sum + frequencyToMonthly(x.amountInRub, x.frequency), 0);
      const recurringMonthlyExpense = data.recurringExpenses.reduce((sum, x) => sum + frequencyToMonthly(x.amountInRub, x.frequency), 0);
      const liabilityMonthlyExpense = data.liabilities.reduce((sum, item) => sum + (item.monthlyExpense || 0), 0);
      const totalIncome = oneTimeIncome + recurringMonthlyIncome + assetMonthlyIncome;
      const totalExpense = oneTimeExpense + recurringMonthlyExpense + liabilityMonthlyExpense;
      const cashflow = totalIncome - totalExpense;
      return { totalIncome, totalExpense, cashflow, hasData: true };
    }
    
    function switchToMonth(year, month) {
      currentYear = year;
      currentMonth = month;
      updateMonthDisplay();
      refreshAllViews();
      // Switch to summary tab
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
      document.querySelector('.tab-button[data-tab="summary"]').classList.add('active');
      document.getElementById('summary-view').classList.add('active');
    }
    
    function renderYearOverview() {
      document.getElementById('report-year-display').textContent = reportYear;
      const monthNames = getMonthNames();
      let html = '<div style="margin-bottom: var(--space-24);">';
      
      // Year totals
      let yearTotalIncome = 0, yearTotalExpense = 0;
      for (let m = 0; m < 12; m++) {
        const summary = getMonthSummary(reportYear, m);
        yearTotalIncome += summary.totalIncome;
        yearTotalExpense += summary.totalExpense;
      }
      const yearCashflow = yearTotalIncome - yearTotalExpense;
      
      html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-16); margin-bottom: var(--space-24);">
        <div class="summary-card"><div class="summary-label">–°—É–º–º–∞—Ä–Ω—ã–π –¥–æ—Ö–æ–¥</div><div class="summary-value positive">${formatNumber(yearTotalIncome)} ‚ÇΩ</div></div>
        <div class="summary-card"><div class="summary-label">–°—É–º–º–∞—Ä–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</div><div class="summary-value negative">${formatNumber(yearTotalExpense)} ‚ÇΩ</div></div>
        <div class="summary-card"><div class="summary-label">–ì–æ–¥–æ–≤–æ–π –∫–µ—à—Ñ–ª–æ—É</div><div class="summary-value ${yearCashflow >= 0 ? 'positive' : 'negative'}">${formatNumber(yearCashflow)} ‚ÇΩ</div></div>
      </div>`;
      
      // Month grid
      html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--space-12);">';
      for (let m = 0; m < 12; m++) {
        const summary = getMonthSummary(reportYear, m);
        const bgColor = summary.hasData ? (summary.cashflow >= 0 ? 'var(--color-bg-3)' : 'var(--color-bg-4)') : 'var(--color-bg-1)';
        const borderColor = summary.hasData ? (summary.cashflow >= 0 ? 'var(--color-success)' : 'var(--color-error)') : 'var(--color-border)';
        
        html += `<div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: var(--radius-base); padding: var(--space-12); cursor: pointer; transition: transform 0.2s;" 
          onclick="switchToMonth(${reportYear}, ${m})" 
          onmouseover="this.style.transform='scale(1.02)'" 
          onmouseout="this.style.transform='scale(1)'">
          <div style="font-weight: var(--font-weight-semibold); font-size: var(--font-size-lg); margin-bottom: var(--space-8);">${monthNames[m]}</div>
          ${summary.hasData ? `
            <div style="font-size: var(--font-size-sm); margin-bottom: var(--space-4);"><span style="color: var(--color-success);">‚Üë ${formatNumber(summary.totalIncome)} ‚ÇΩ</span></div>
            <div style="font-size: var(--font-size-sm); margin-bottom: var(--space-4);"><span style="color: var(--color-error);">‚Üì ${formatNumber(summary.totalExpense)} ‚ÇΩ</span></div>
            <div style="font-size: var(--font-size-md); font-weight: var(--font-weight-semibold); color: ${summary.cashflow >= 0 ? 'var(--color-success)' : 'var(--color-error)'};">= ${formatNumber(summary.cashflow)} ‚ÇΩ</div>
          ` : `<div style="color: var(--color-text-secondary); font-size: var(--font-size-sm); font-style: italic;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>`}
        </div>`;
      }
      html += '</div></div>';
      
      // Chart
      html += '<div style="margin-top: var(--space-32); background: var(--color-surface); border: 1px solid var(--color-card-border); border-radius: var(--radius-lg); padding: var(--space-24);">';
      html += '<h3 style="margin: 0 0 var(--space-16) 0;">–ì—Ä–∞—Ñ–∏–∫ –ø–æ –º–µ—Å—è—Ü–∞–º</h3>';
      html += '<canvas id="year-chart" style="width:100%;height:300px;max-height:300px;"></canvas>';
      html += '</div>';
      
      document.getElementById('year-overview').innerHTML = html;
      
      // Render chart
      setTimeout(() => {
        if (window.Chart) {
          const ctx = document.getElementById('year-chart').getContext('2d');
          if (window.__yearChart) window.__yearChart.destroy();
          const monthSummaries = [];
          for (let m = 0; m < 12; m++) {
            monthSummaries.push(getMonthSummary(reportYear, m));
          }
          window.__yearChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: monthNames,
              datasets: [
                {label: '–î–æ—Ö–æ–¥—ã', data: monthSummaries.map(s => s.totalIncome), backgroundColor: '#1FB8CD'},
                {label: '–†–∞—Å—Ö–æ–¥—ã', data: monthSummaries.map(s => s.totalExpense), backgroundColor: '#DB4545'}
              ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: {legend: {display: true}}, scales: {y: {beginAtZero: true}} }
          });
        }
      }, 100);
    }
    
    // Initialize reports when tab is clicked
    document.querySelector('.tab-button[data-tab="reports"]').addEventListener('click', () => {
      reportYear = currentYear;
      if (reportViewType === 'monthly') {
        renderMonthlyReport();
      } else {
        renderYearOverview();
      }
    });
    
    // Load Chart.js
    (function(){
      let s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/chart.js'; document.body.appendChild(s);
    })();
  </script>
</body>
</html>
